<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFL Sim — Batch Simulator</title>
<style>
  :root{
    --bg:#0b1220;--panel:#121a2a;--card:#0e1630;--text:#eef2ff;--muted:#93a0b1;
    --accent:#5eead4;--good:#10b981;--warn:#f59e0b;--danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:grid;place-items:start;
  }
  main{width:min(1100px,94vw);margin:24px auto;display:grid;gap:16px}
  h1{margin:0 0 2px;font-size:22px;letter-spacing:.2px}
  .sub{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .panel{background:var(--panel);border-radius:14px;padding:12px}
  .card{background:var(--card);border-radius:12px;padding:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  select,input,button{border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--text);padding:8px 10px}
  button{background:#111827;border:1px solid #263246;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#21c7b8,#0fb3a6);border:none;color:#072c2a;font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi{background:#0c1729;border:1px solid #1f2937;border-radius:12px;padding:10px}
  .kpi .title{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
  .kpi .value{font-size:18px;font-weight:800;margin-top:6px}
  .kpi .subvalue{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:left;white-space:nowrap}
  th{font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:.06em;font-size:11px}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace, Menlo, Consolas, monospace}
  .status-pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0b1428;border:1px solid #263246;font-size:12px}
  .status-pill .dot{width:8px;height:8px;border-radius:999px;background:#6b7280}
  .pill-ok .dot{background:var(--good)}
  .pill-warn .dot{background:var(--warn)}
  .pill-bad .dot{background:var(--danger)}
  .progress{height:10px;background:#0c1729;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#5eead4,#60a5fa)}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<main>
  <div class="row" style="justify-content:space-between">
    <div>
      <h1>Batch Simulator</h1>
      <div class="sub">Run hundreds of games and get realistic distributions.</div>
    </div>
    <div id="enginePill" class="status-pill"><span class="dot"></span><span>Engine not loaded</span></div>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <label>Roster CSV (optional ?players=…)</label>
        <input id="csvUrl" style="width:480px" placeholder="Defaults to layer3_rosters.csv next to this file" />
      </div>
      <div>
        <label>Home team</label>
        <select id="selHome"></select>
      </div>
      <div>
        <label>Away team</label>
        <select id="selAway"></select>
      </div>
      <div>
        <label>Games (N)</label>
        <input id="numGames" type="number" min="1" step="1" value="500" style="width:100px" />
      </div>
      <div>
        <label>Seed (optional)</label>
        <input id="seed" type="number" step="1" placeholder="random" style="width:120px" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnRun" class="primary">Run Batch</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="hint">Tip: You can also prefill with <span class="mono">?players=…&home=IND&away=CAR&n=500&seed=42</span>.</div>
    </div>
    <div class="row" style="margin-top:10px;align-items:center;gap:16px">
      <div class="progress" style="flex:1"><div id="bar" class="bar"></div></div>
      <div id="progressText" class="muted mono">Idle</div>
      <button id="btnCSV">Download Raw CSV</button>
    </div>
  </div>

  <div class="card">
    <div class="kpi-grid" id="kpiGrid">
      <!-- KPIs injected here -->
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Distributions (mean ± sd, min…p10…p50…p90…max)</h3>
    <table id="tblDist">
      <thead>
        <tr>
          <th>Metric</th>
          <th>Mean</th><th>SD</th>
          <th>Min</th><th>P10</th><th>P25</th><th>P50</th><th>P75</th><th>P90</th><th>Max</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Quick per-team means (across games)</h3>
    <table id="tblTeams">
      <thead>
        <tr>
          <th>Side</th><th>Pts</th><th>Yards</th><th>Plays</th><th>Drives</th><th>YPP</th><th>TOs</th><th>Plays/Drive</th><th>Scoring-Drive%</th><th>Time/Drive (s)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script type="module">
  import { loadLeague } from './data_models.js'; // uses your CSV loader
  import { simulateGame, simulateGameSeries } from './game_engine.js';

  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const PARAMS = new URLSearchParams(location.search);
  const val = (k) => (PARAMS.get(k) ?? '').trim();
  const setPill = (cls, text) => {
    const pill = $('enginePill'); pill.classList.remove('pill-ok','pill-warn','pill-bad');
    pill.classList.add(cls); pill.querySelector('span:nth-child(2)').textContent = text;
  };

  function mean(a){ return a.length? a.reduce((s,x)=>s+x,0)/a.length : 0; }
  function sd(a){
    if(a.length<2) return 0;
    const m = mean(a); const v = a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1);
    return Math.sqrt(v);
  }
  function quantile(sorted, q){
    if(!sorted.length) return 0;
    const pos = (sorted.length-1)*q; const lo = Math.floor(pos), hi = Math.ceil(pos);
    if(lo===hi) return sorted[lo];
    return sorted[lo] + (sorted[hi]-sorted[lo])*(pos-lo);
  }
  function pct(x){ return (x*100).toFixed(1)+'%'; }
  function fmt1(x){ return Number.isFinite(x)? x.toFixed(1) : '—'; }
  function fmt0(x){ return Number.isFinite(x)? Math.round(x).toString() : '—'; }

  function distRow(name, arr){
    const s = [...arr].sort((a,b)=>a-b);
    return {
      name,
      mean: mean(arr), sd: sd(arr),
      min: s[0] ?? 0, p10: quantile(s,0.10), p25: quantile(s,0.25),
      p50: quantile(s,0.50), p75: quantile(s,0.75), p90: quantile(s,0.90),
      max: s[s.length-1] ?? 0
    };
  }

  // ---------- state ----------
  let league = null;
  let teams = [];

  // Resolve CSV URL (query param > input field > default next to file)
  function resolveCsvUrl(){
    const fromParam = val('players').replace('/refs/heads/', '/');
    const fromInput = $('csvUrl').value.trim();
    if(fromParam) return fromParam;
    if(fromInput) return fromInput;
    return './layer3_rosters.csv';
  }

  // ---------- UI wiring ----------
  async function init(){
    try{
      setPill('','Loading league…');
      $('csvUrl').value = val('players') || '';
      const nParam = val('n'); if(nParam) $('numGames').value = Math.max(1, parseInt(nParam,10) || 500);
      const seedParam = val('seed'); if(seedParam) $('seed').value = parseInt(seedParam,10);

      // Load league using your loader (works with local or ?players= URL)
      const CSV = resolveCsvUrl();
      league = await loadLeague(CSV);  // pulls and builds Team objects
      teams = league.teams || [];
      if(!teams.length) throw new Error('No teams found in league data');

      // Populate selects
      const homeSel = $('selHome'), awaySel = $('selAway');
      const fragH = document.createDocumentFragment(), fragA = document.createDocumentFragment();
      for(const t of teams){
        const id = t.teamId || t.id; const name = t.teamName || t.team_name || id;
        const optH = document.createElement('option'); optH.value = id; optH.textContent = `${id} — ${name}`; fragH.appendChild(optH);
        const optA = document.createElement('option'); optA.value = id; optA.textContent = `${id} — ${name}`; fragA.appendChild(optA);
      }
      homeSel.appendChild(fragH); awaySel.appendChild(fragA);

      // Preselect via ?home=&away=
      const find = (needle) => teams.find(t=>{
        const id=(t.teamId||t.id||'').toString().toLowerCase();
        const nm=(t.teamName||t.team_name||'').toLowerCase();
        const ab=(t.abbr||'').toLowerCase();
        const want=needle.toLowerCase();
        return id===want||nm===want||ab===want;
      });
      const h = val('home'); const a = val('away');
      if(h && find(h)) homeSel.value = find(h).teamId || find(h).id;
      if(a && find(a)) awaySel.value = find(a).teamId || find(a).id;

      setPill('pill-ok','Engine ready');
    }catch(err){
      console.error(err);
      setPill('pill-bad','Failed to load');
    }

    $('btnRun').addEventListener('click', runBatch);
    $('btnCSV').addEventListener('click', downloadCsv);
  }

  function findTeamById(id){
    return teams.find(t => (t.teamId||t.id||'').toString() === id.toString()) || null;
  }

  function progress(i, n){
    const pct = n? (i/n)*100 : 0; $('bar').style.width = pct.toFixed(1)+'%';
    $('progressText').textContent = n? `Simulated ${i}/${n}` : 'Idle';
  }

  // ---------- Batch run ----------
  async function runBatch(){
    const idH = $('selHome').value, idA = $('selAway').value;
    const home = findTeamById(idH), away = findTeamById(idA);
    const N = Math.max(1, parseInt(($('numGames').value||'').trim(),10) || 500);
    const seedStr = $('seed').value.trim(); const baseSeed = seedStr ? parseInt(seedStr,10) : undefined;

    if(!home || !away){ alert('Pick valid teams'); return; }

    // Use the engine’s series helper so RNG seeds can step per game
    // (same helper you already export). :contentReference[oaicite:2]{index=2}
    const results = [];
    progress(0,N);
    for(let i=0;i<N;i++){
      const r = simulateGame(home, away, { seed: baseSeed!=null ? baseSeed+i : undefined });
      results.push(r);
      if((i+1)%10===0 || i===N-1) progress(i+1,N);
      // Let the UI breathe
      if((i+1)%200===0) await new Promise(r=>setTimeout(r,0));
    }

    renderStats(results, home, away);
    window.__BATCH_RAW__ = { results, homeId: idH, awayId: idA };
  }

  // ---------- Aggregation ----------
  function derivePerGame(r){
    const H = r.teamStats?.home || {plays:0,yardsTotal:0,turnovers:0,yardsPerPlay:0,rushYards:0,passYards:0};
    const A = r.teamStats?.away || {plays:0,yardsTotal:0,turnovers:0,yardsPerPlay:0,rushYards:0,passYards:0};

    const drivesHome = r.drives.filter(d=>d.offense==='home').length;
    const drivesAway = r.drives.filter(d=>d.offense==='away').length;
    const drivesTotal = drivesHome + drivesAway;

    const scoringDrives = r.drives.filter(d => /TD|FG Good|Safety/.test(d.result)).length;
    const dur = r.drives.map(d=>d.durationSec||0);
    const avgTimePerDrive = dur.length? dur.reduce((s,x)=>s+x,0)/dur.length : 0;

    const playsTotal = H.plays + A.plays;
    const yardsTotal = H.yardsTotal + A.yardsTotal;
    const yppTotal = playsTotal ? yardsTotal/playsTotal : 0;

    return {
      ptsHome: r.score.home,
      ptsAway: r.score.away,
      ptsTotal: r.score.home + r.score.away,

      yardsHome: H.yardsTotal, yardsAway: A.yardsTotal, yardsTotal,
      rushYdsHome: H.rushYards||0, rushYdsAway: A.rushYards||0,
      passYdsHome: H.passYards||0, passYdsAway: A.passYards||0,

      playsHome: H.plays, playsAway: A.plays, playsTotal,
      yppHome: H.yardsPerPlay||0, yppAway: A.yardsPerPlay||0, yppTotal,

      drivesHome, drivesAway, drivesTotal,
      toHome: H.turnovers||0, toAway: A.turnovers||0, toTotal: (H.turnovers||0)+(A.turnovers||0),

      playsPerDriveHome: drivesHome? H.plays/drivesHome : 0,
      playsPerDriveAway: drivesAway? A.plays/drivesAway : 0,
      playsPerDriveTotal: drivesTotal? playsTotal/drivesTotal : 0,

      scoringDriveRate: drivesTotal? scoringDrives/drivesTotal : 0,
      timePerDriveSec: avgTimePerDrive,
    };
  }

  function aggregate(results){
    const rows = results.map(derivePerGame);

    function col(k){ return rows.map(r=>r[k]); }

    const dist = [
      distRow('Total Points', col('ptsTotal')),
      distRow('Total Yards', col('yardsTotal')),
      distRow('Total Plays', col('playsTotal')),
      distRow('Total Drives', col('drivesTotal')),
      distRow('Turnovers (Total)', col('toTotal')),
      distRow('Yards / Play (Total)', col('yppTotal')),
      distRow('Plays / Drive (Total)', col('playsPerDriveTotal')),
      distRow('Scoring-Drive %', col('scoringDriveRate').map(x=>x*100)),
      distRow('Time / Drive (sec)', col('timePerDriveSec')),
    ];

    const perTeam = {
      home: {
        pts: mean(col('ptsHome')), yards: mean(col('yardsHome')), plays: mean(col('playsHome')),
        drives: mean(col('drivesHome')), ypp: mean(col('yppHome')), tos: mean(col('toHome')),
        ppd: mean(col('playsPerDriveHome')), sdr: mean(col('scoringDriveRate'))*100/2, // half-share approximation
        tpd: mean(col('timePerDriveSec'))
      },
      away: {
        pts: mean(col('ptsAway')), yards: mean(col('yardsAway')), plays: mean(col('playsAway')),
        drives: mean(col('drivesAway')), ypp: mean(col('yppAway')), tos: mean(col('toAway')),
        ppd: mean(col('playsPerDriveAway')), sdr: mean(col('scoringDriveRate'))*100/2,
        tpd: mean(col('timePerDriveSec'))
      }
    };

    return { rows, dist, perTeam };
  }

  // ---------- Rendering ----------
  function renderStats(results, home, away){
    const { dist, perTeam } = aggregate(results);
    const N = results.length;

    // KPIs
    const map = Object.fromEntries(dist.map(d => [d.name, d]));
    const kpis = [
      ['Total Points', x => `${fmt1(x.mean)} ± ${fmt1(x.sd)}`],
      ['Total Yards', x => `${fmt1(x.mean)} ± ${fmt1(x.sd)}`],
      ['Total Plays', x => `${fmt1(x.mean)} ± ${fmt1(x.sd)}`],
      ['Total Drives', x => `${fmt1(x.mean)} ± ${fmt1(x.sd)}`],
      ['Yards / Play (Total)', x => fmt2(x.mean=+x.mean, x.sd=+x.sd)],
      ['Plays / Drive (Total)', x => fmt1(x.mean)],
      ['Scoring-Drive %', x => `${fmt1(x.mean)}%`],
      ['Turnovers (Total)', x => fmt1(x.mean)],
    ];
    const grid = $('kpiGrid'); grid.innerHTML = '';
    function fmt2(){ const a=[...arguments]; return `${fmt1(a[0])} ± ${fmt1(a[1])}`; }
    for(const [key, fn] of kpis){
      const data = map[key];
      const div = document.createElement('div');
      div.className = 'kpi';
      div.innerHTML = `<div class="title">${key}</div><div class="value">${fn(data)}</div><div class="subvalue muted">N=${N}</div>`;
      grid.appendChild(div);
    }

    // Distribution table
    const tbody = $('tblDist').querySelector('tbody'); tbody.innerHTML = '';
    for(const d of dist){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.name}</td>
        <td>${fmt1(d.mean)}</td><td>${fmt1(d.sd)}</td>
        <td>${fmt1(d.min)}</td><td>${fmt1(d.p10)}</td><td>${fmt1(d.p25)}</td>
        <td>${fmt1(d.p50)}</td><td>${fmt1(d.p75)}</td><td>${fmt1(d.p90)}</td><td>${fmt1(d.max)}</td>
      `;
      tbody.appendChild(tr);
    }

    // Per-team quick means
    const tb2 = $('tblTeams').querySelector('tbody'); tb2.innerHTML = '';
    function row(side,label){
      const t = perTeam[side];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${label}</td>
        <td>${fmt1(t.pts)}</td>
        <td>${fmt1(t.yards)}</td>
        <td>${fmt1(t.plays)}</td>
        <td>${fmt1(t.drives)}</td>
        <td>${fmt1(t.ypp)}</td>
        <td>${fmt1(t.tos)}</td>
        <td>${fmt1(t.ppd)}</td>
        <td>${fmt1(t.sdr)}</td>
        <td>${fmt1(t.tpd)}</td>
      `;
      tb2.appendChild(tr);
    }
    const homeLabel = (home.teamId||home.id)+' — '+(home.teamName||home.team_name||'');
    const awayLabel = (away.teamId||away.id)+' — '+(away.teamName||away.team_name||'');
    row('home', homeLabel);
    row('away', awayLabel);
  }

  // ---------- CSV download ----------
  function toCsv(rows){
    if(!rows?.length) return '';
    const cols = Object.keys(rows[0]);
    const lines = [cols.join(',')];
    for(const r of rows){
      lines.push(cols.map(k=>String(r[k] ?? '')).join(','));
    }
    return lines.join('\n');
  }

  function downloadCsv(){
    const bundle = window.__BATCH_RAW__;
    if(!bundle){ alert('Run a batch first.'); return; }
    const rows = bundle.results.map(derivePerGame);
    const csv = toCsv(rows);
    const blob = new Blob([csv], { type:'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `batch_results_${bundle.homeId}_vs_${bundle.awayId}.csv`;
    a.click();
  }

  // ---------- boot ----------
  init();
</script>
</body>
</html>

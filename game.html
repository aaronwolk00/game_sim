<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NFL Sim — GM</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* =========================
   LAYOUT SIZING — TWEAK HERE
   ========================= */
:root{
  --left-col:   320px;       /* left panel width */
  --center-min: 900px;      /* min width of the middle stack */
  --right-col:  520px;       /* right panel width */
  --gutter:     16px;        /* space between columns */
  --pad-x:      8px;         /* page side padding (shrinks outer border look) */
  --max-width:  1720px;      /* overall page max */
}

/* ===== Base theme (unchanged) ===== */
:root{
  --bg:#0b1220; --panel:#121a2a; --card:#0e1630; --muted:#93a0b1; --text:#eef2ff;
  --home:#4ade80; --away:#60a5fa; --good:#34d399; --bad:#f87171;
  --los:#93c5fd;   /* LOS */
  --first:#facc15; /* 1st down */
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{padding:10px 14px;border-bottom:1px solid #1c2440;display:flex;align-items:center;gap:10px}
h1{margin:0;font-size:16px}

/* ===== SINGLE grid definition ===== */
main{
  display:grid;
  grid-template-columns: var(--left-col) minmax(var(--center-min), 1fr) var(--right-col);
  gap: var(--gutter);
  width: min(var(--max-width), 100vw);
  margin: 0 auto;
  padding: 12px var(--pad-x);
}

/* Collapse to single column on smaller viewports */
@media (max-width: 1400px){
  main{
    grid-template-columns: 1fr;
    width: min(1100px, 98vw);
  }
}

/* Trim margins so the outside doesn’t look like a big border */
.panel, .card, .box, .sidebar, .teambox { margin: 0; }

.panel{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px}
input[type="text"],input[type="number"],select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #243055;background:var(--card);color:var(--text)}
input[type="file"]{width:100%}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.line{height:1px;background:#1c2440;margin:10px 0;border-radius:2px}
button{padding:10px 12px;border-radius:10px;border:none;background:#5eead4;color:#0a0f17;font-weight:700;cursor:pointer}
button.secondary{background:#1e293b;color:#dbe3ef;border:1px solid #2a355a}
button.ghost{background:var(--card);border:1px dashed #334155;color:#cbd5e1}
button:disabled{opacity:.6;cursor:not-allowed}
.scoreboard{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px}
.teamName{font-weight:800}
.score{font-size:34px;font-weight:900}
.sub{font-size:11px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}

.tabs{display:flex;gap:6px;margin-top:6px}
.tab{padding:6px 10px;border-radius:999px;border:1px solid #2a355a;background:#0e1630;color:#cbd5e1;cursor:pointer;font-size:12px}
.tab.active{background:#1e293b;color:#e5e7eb}

.feed{max-height:52vh;overflow:auto;font-size:13px;line-height:1.35}
.item{padding:8px 10px;border-bottom:1px solid #1c2544;border-left:3px solid transparent;display:flex;justify-content:space-between;gap:10px}
.item.home{border-left-color:var(--home)}
.item.away{border-left-color:var(--away)}
.item.score{background:rgba(52,211,153,.06);border-left-color:var(--good)}
.feed{font-size:13px;line-height:1.35}
.item.score{font-size:13px;font-weight:600}
.feed h1,.feed h2,.feed h3{font-size:13px;font-weight:700;margin:0}
.tag{font-size:11px;color:#9cd2ff;background:#1a2444;border-radius:6px;padding:2px 6px;margin-right:6px}
.aux{color:#a3b2c7;font-size:12px;white-space:nowrap}

.table{width:100%;border-collapse:collapse;font-size:12px}
.table th,.table td{border-bottom:1px solid #1f2740;padding:6px 7px;text-align:left}
.right{text-align:right}

.feed .item{ font-size:13px; line-height:1.3; }
.feed .item.score{font-size:13px; line-height:1.25; padding:8px 10px;}
.feed .item.score .tag{font-size:10px}
.feed .item *{ font-size:inherit; }

/* Field & HUD */
.fieldWrap{position:relative;display:grid;gap:6px}
canvas#field{width:100%;height:260px;background:#062b22;border-radius:12px;border:1px solid #0b3a52}
.hudPill{position:absolute;top:6px;left:50%;transform:translateX(-50%);background:rgba(8,12,24,.78);border:1px solid #2a355a;border-radius:999px;padding:4px 10px;font-size:12px;backdrop-filter:blur(2px)}
.lastPlay{background:var(--card);border:1px solid #243055;border-radius:12px;padding:8px;font-size:13px}
.wpBox{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid #243055;border-radius:12px;padding:6px 8px}
.crowdBox{background:var(--card);border:1px solid #243055;border-radius:12px;padding:8px;margin-top:8px}
.meter{width:100%;height:8px;background:#0e1630;border:1px solid #233055;border-radius:999px;overflow:hidden}
#crowdBar{height:100%;width:0%;background:linear-gradient(90deg,#93c5fd,#34d399);transition:width .25s ease}
.wpVal{font-weight:800}
.pill{display:inline-block;padding:3px 7px;border-radius:8px;background:#0e1630;border:1px solid #233055;color:#cfe1ff;font-size:11px}
.subtabs{display:flex;gap:6px;margin:8px 0}
.subtab{padding:4px 8px;border-radius:8px;border:1px solid #243055;background:#0e1630;color:#d2e0ff;cursor:pointer;font-size:11px}
.subtab.active{background:#1e293b}
</style>
</head>

<body>
<header><h1>NFL Sim — GMG</h1></header>

<main>
  <!-- LEFT -->
  <section class="panel">
    <div class="scoreboard" style="gap:6px;margin-bottom:6px">
      <div class="teamName" id="homeName" style="color:var(--home)">Home</div>
      <div class="score"><span id="homeScore">0</span>–<span id="awayScore">0</span></div>
      <div class="teamName" id="awayName" style="color:var(--away);text-align:right">Away</div>
      <div class="sub" style="grid-column:1/-1">
        Poss: <span id="poss">Home</span> • Q<span id="qtr">1</span> •
        <span id="clock">15:00</span> • TO: <span id="toHome">3</span>/<span id="toAway">3</span>
      </div>
    </div>
    
    <!-- NEW: stadium line driven by stadium CSV -->
    <div class="small" id="stadiumLine"
         style="margin:2px 0 6px 0;color:var(--muted)">
      Stadium: (generic)
    </div>

    <div class="row">
      <div><label>Home Name</label><input id="homeLabel" type="text" value="Home"></div>
      <div><label>Away Name</label><input id="awayLabel" type="text" value="Away"></div>
    </div>

    <div class="row">
      <div><label>Seed</label><input id="seed" type="text" value="2025-A"></div>
      <div><label>Play Speed (ms)</label><input id="speed" type="number" min="0" value="140"></div>
    </div>

    <!-- Teams (auto-populated from the roster .xlsx in this folder) -->
    <div class="row" style="grid-template-columns:1fr">
      <div>
        <label class="small">Loaded Teams</label>
        <div class="row" style="grid-template-columns:1fr 1fr">
          <select id="homeTeamSel"></select>
          <select id="awayTeamSel"></select>
        </div>
        <div id="rosterStatus" class="small" style="margin-top:6px;color:var(--muted)"></div>
        <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap">
          <button id="btnListCsvTeams" class="ghost">List CSV Teams</button>
          <button id="btnForceLocalCsv" class="ghost">Force Local CSV</button>
        </div>
        <pre id="csvOut" class="small"
             style="margin-top:6px;max-height:140px;overflow:auto;white-space:pre-wrap;
                    background:#0e1630;border:1px dashed #334155;padding:6px;border-radius:8px;display:none"></pre>        
      </div>
    </div>

    <div class="line"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="startBtn">Start</button>
      <button id="pauseBtn" class="secondary" disabled>Pause</button>
      <button id="resetBtn" class="secondary">Reset</button>
      <button id="exportCsv" class="ghost" disabled>Export CSV</button>
    </div>

    <div class="line"></div>
    <details>
      <summary>Game Feel</summary>
      <div class="row" style="margin-top:8px">
        <div><label>Variance</label><input id="feelVariance" type="range" min="0" max="100" value="40"></div>
        <div><label>Ref Strictness</label><input id="feelRefs" type="range" min="0" max="100" value="55"></div>
      </div>
      <div class="row">
        <div><label>Crowd Noise</label><input id="feelCrowd" type="range" min="0" max="100" value="60"></div>
        <div><label>Pace</label><input id="feelPace" type="range" min="0" max="100" value="50"></div>
      </div>
      <div class="row">
        <div><label>Weather</label>
          <select id="precip"><option>None</option><option>Light Rain</option><option>Heavy Rain</option><option>Snow</option></select>
        </div>
        <div><label>Wind (mph)</label><input id="wind" type="number" value="7"></div>
      </div>
      <div class="row">
        <div><label>Temp (°F)</label><input id="temp" type="number" value="45"></div>
        <div><label class="small">Fans auto-managed</label><div class="pill" id="fansPill">Fans: 0</div></div>
      </div>
    </details>

    <div class="line"></div>
    <details>
      <summary>Coaching</summary>
      <div class="row" style="margin-top:8px">
        <div><label>Pass% Early</label><input id="passEarly" type="range" min="30" max="80" value="55"></div>
        <div><label>Pass% Late</label><input id="passLate" type="range" min="35" max="90" value="62"></div>
      </div>
      <div class="row">
        <div><label>4th Aggression</label><input id="aggr4th" type="range" min="0" max="100" value="35"></div>
        <div><label>2-Pt Try %</label><input id="twoPct" type="range" min="0" max="100" value="5"></div>
      </div>
    </details>
  </section>

  <!-- CENTER -->
  <section class="panel">
    <div class="fieldWrap">
      <canvas id="field" width="980" height="260"></canvas>
      <div id="hud" class="hudPill">Q1 • 15:00 • 1st & 10 @ Own 25 • Poss: Home</div>
      <div class="lastPlay" id="lastPlay">Last Play: —</div>
      <div class="wpBox">
        <div>Home Win %: <span id="wpVal" class="wpVal">50.0%</span></div>
        <button id="toggleAdv" class="ghost">PBP: Advanced Off</button>
        <canvas id="wpChart" height="10"></canvas>
      </div>
      <div class="crowdBox">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <div>Crowd Impact</div>
          <div class="small"><span id="crowdPct">0%</span></div>
        </div>
        <div class="meter"><div id="crowdBar"></div></div>
      </div>
    </div>
    <div class="line"></div>
    <div class="tabs">
      <button id="tabPlays" class="tab active">Play-by-Play</button>
      <button id="tabScoring" class="tab">Scoring</button>
      <button id="tabDrives" class="tab">Drives</button>
      <button id="tabAdvanced" class="tab">Advanced</button>
    </div>
    <div id="feed" class="feed"></div>
  </section>
  
  <!-- RIGHT -->
  <section class="panel">
    <div style="font-weight:800;margin-bottom:6px">Team Box</div>
    <div id="boxWrap"></div>
    <div class="line"></div>
    <div style="font-weight:800;margin-bottom:6px">Leaders</div>
    <div id="leaders"></div>
    <div class="line"></div>
    <div style="font-weight:800;margin-bottom:6px">Top EPA Plays</div>
    <div id="topEpa" class="small"></div>
  </section>
</main>

<script src="engine.js"></script>
<script>

/* ===== Advanced Tab (team + players) ===== */
function renderAdvanced(){
  const recAgg = (T)=>{
    let targets=0,air=0,yac=0,catches=0;
    (T.wr||[]).concat(T.te||[]).concat(T.rb||[]).forEach(p=>{
      const a=p.adv||{};
      targets+=a.targets||0;catches+=a.catches||0;
      air+=a.air||0; yac+=a.yac||0;
    });
    return {adot:targets?air/targets:0, yacPer:catches?yac/catches:0};
  };

  const teamTable = (name,T)=>{
    const qb=T.qb?.adv||{};
    const epaP=(T.stats.team.epa/(T.stats.team.plays||1)).toFixed(2);
    const db=qb.dropbacks||0, pr=db?(qb.pressures/db*100).toFixed(1):'0.0';
    const ttt=qb.tttN?(qb.ttt/qb.tttN).toFixed(2):'0.00';
    const cpoe= qb.expN?(((qb.comp||0)/qb.expN - qb.expSum/qb.expN)*100).toFixed(1):'0.0';
    const rec = recAgg(T);
    const adot = rec.adot.toFixed(1), yacPer = rec.yacPer.toFixed(1);
    const topSpeed=(T.players||[]).reduce((m,p)=>Math.max(m,p.adv?.fast||0),0).toFixed(1);
    return `<tr><th>${name}</th><td>${epaP}</td><td>${db}</td><td>${pr}%</td><td>${ttt}</td><td>${cpoe}%</td><td>${adot}</td><td>${yacPer}</td><td>${topSpeed}</td></tr>`;
  };

  const teamHTML = `
    <div class="small" style="margin-bottom:6px">Team Advanced</div>
    <table class="table">
      <thead><tr><th></th><th>EPA/play</th><th>Dropbacks</th><th>Pressure%</th><th>TTT (s)</th><th>CPOE</th><th>aDOT</th><th>YAC/rec</th><th>Top speed (mph)</th></tr></thead>
      <tbody>${teamTable(homeLabel.value,HOME)}${teamTable(awayLabel.value,AWAY)}</tbody>
    </table>`;

  const playersHTML = renderPlayersTables();
  feed.innerHTML = teamHTML + '<div class="line"></div>' + playersHTML;
}

function renderPlayersTables(){
  const rowsQBs = (T)=> T.qb?[T.qb]:[];
  const rowsRBs = (T)=> T.rb||[];
  const rowsWRs = (T)=> (T.wr||[]).concat(T.te||[]);
  const rowsDEF = (T)=> (T.dl||[]).concat(T.lb||[]).concat(T.db||[]);
  const fmt=(n)=> (n??0);

  const qbTable = (teamName,T)=>`<div class="small" style="margin-top:6px">${teamName} — Quarterbacks</div>
    <table class="table"><thead><tr><th>Name</th><th>C/Att</th><th>Yds</th><th>TD</th><th>INT</th><th>Sacks</th><th>DB</th><th>Press%</th><th>TTT</th><th>CPOE</th></tr></thead>
    <tbody>${rowsQBs(T).map(q=>{const a=q.adv||{};const db=a.dropbacks||0,pr=db?((a.pressures||0)/db*100).toFixed(1):'0.0';const ttt=a.tttN? (a.ttt/a.tttN).toFixed(2):'0.00';const cpoe=a.expN?(((a.comp||0)/a.expN - a.expSum/a.expN)*100).toFixed(1):'0.0';return `<tr><td>${q.first} ${q.last}</td><td>${fmt(a.comp)}/${fmt(a.att)}</td><td>${fmt(a.yards)}</td><td>${fmt(a.td)}</td><td>${fmt(a.int)}</td><td>${fmt(a.sacks)}</td><td>${db}</td><td>${pr}%</td><td>${ttt}</td><td>${cpoe}%</td></tr>`;}).join('')}</tbody></table>`;

  const rbTable = (teamName,T)=>`<div class="small" style="margin-top:6px">${teamName} — Rushers</div>
    <table class="table"><thead><tr><th>Name</th><th>Att</th><th>Yds</th><th>TD</th><th>Top mph</th></tr></thead>
    <tbody>${rowsRBs(T).map(p=>{const a=p.adv||{};return `<tr><td>${p.first} ${p.last}</td><td>${fmt(a.carries)}</td><td>${fmt(a.ry)}</td><td>${fmt(a.td)}</td><td>${(a.fast||0).toFixed(1)}</td></tr>`;}).join('')}</tbody></table>`;

  const wrTable = (teamName,T)=>`<div class="small" style="margin-top:6px">${teamName} — Receivers</div>
    <table class="table"><thead><tr><th>Name</th><th>Tgt</th><th>Rec</th><th>Yds</th><th>TD</th><th>aDOT</th><th>YAC/rec</th><th>Drops</th><th>Sep</th><th>Top mph</th></tr></thead>
    <tbody>${rowsWRs(T).map(p=>{const a=p.adv||{};const adot=a.ayN?(a.ayDepth/a.ayN).toFixed(1):'0.0';const yac=a.catches? (a.yac/a.catches).toFixed(1):'0.0';const sep=a.sepN? (a.sep/a.sepN).toFixed(1):'0.0';return `<tr><td>${p.first} ${p.last}</td><td>${fmt(a.targets)}</td><td>${fmt(a.catches)}</td><td>${fmt(a.recY)}</td><td>${fmt(a.td)}</td><td>${adot}</td><td>${yac}</td><td>${fmt(a.drops)}</td><td>${sep}</td><td>${(a.fast||0).toFixed(1)}</td></tr>`;}).join('')}</tbody></table>`;

  const defTable = (teamName,T)=>`<div class="small" style="margin-top:6px">${teamName} — Defense</div>
    <table class="table"><thead><tr><th>Name</th><th>Tkl</th><th>Sacks</th><th>INT</th><th>PD</th></tr></thead>
    <tbody>${rowsDEF(T).map(p=>{const a=p.adv||{};return `<tr><td>${p.first} ${p.last}</td><td>${fmt(a.tkl)}</td><td>${fmt(a.sk)}</td><td>${fmt(a.ints)}</td><td>${fmt(a.pd)}</td></tr>`;}).join('')}</tbody></table>`;

  return qbTable(homeLabel.value,HOME)+qbTable(awayLabel.value,AWAY)
       + rbTable(homeLabel.value,HOME)+rbTable(awayLabel.value,AWAY)
       + wrTable(homeLabel.value,HOME)+wrTable(awayLabel.value,AWAY)
       + defTable(homeLabel.value,HOME)+defTable(awayLabel.value,AWAY);
}


/* ===== Export ===== */
function exportBlob(name,data,type){const b=new Blob([data],{type});const url=URL.createObjectURL(b);const a=document.createElement('a');a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}
exportCsv.onclick = () => {
  const lines = ['tag,offense,line,scoring,epa,delta_wp,drive_ep'];
  plays.forEach(p => {
    const safeLine = (p.line || '').replace(/"/g, '""');
    const scoringFlag = p.scoring ? '1' : '0';
    const epa = Number.isFinite(p.epa) ? p.epa.toFixed(3) : '';
    const dwp = Number.isFinite(p.wpd) ? p.wpd.toFixed(4) : '';
    const dep = Number.isFinite(p.driveEp) ? p.driveEp.toFixed(3) : '';

    lines.push([
      p.tag,
      p.off || '',
      `"${safeLine}"`,
      scoringFlag,
      epa,
      dwp,
      dep
    ].join(','));
  });
  exportBlob('play_log.csv', lines.join('\n'), 'text/csv');
};


/* ===== Init (rosters + (optional) stadiums) ===== */
(async function init(){
  startBtn.disabled = true;

  // 1) Safe boot visuals before any CSVs load
  try {
    sim = {
      rng:  rngFromSeed('seed'),
      score:{ home:0, away:0 },
      hud:  { poss:'Home', qtr:1, secs:900, down:1, dist:10, yard:25 },
      crowd:{ cap:0, present:0, mood:0 }
    };
    Field.render({ hud: sim.hud });
    updateHUD();
    updateScore();
    drawWP();
    renderBox();
    renderLeaders();
    renderTopEpa();
    renderCrowdMeter();
  } catch (e) {
    console.warn('boot visuals failed:', e);
  }

  // helper to pick two distinct teams if URLs are missing/bad
  function pickTwoDistinct(list){
    if (!list || !list.length) return ['', ''];
    if (list.length === 1) return [list[0], list[0]];

    const i = Math.floor(Math.random() * list.length);
    let   j = Math.floor(Math.random() * list.length);
    if (j === i) j = (i + 1) % list.length;
    return [list[i], list[j]];
  }

  try {
    
    await tryLoadStadiumCsv();


    // 3) Load players.csv with smart ordering:
    //    - if ?players= is present → try that path first, then local
    //    - otherwise → local first, then remote/fallback
    let loaded = false;
    const haveParamCsv = !!RAW_PLAYERS_PARAM;

    if (haveParamCsv){
      // prefer the ?players= CSV
      loaded = await tryLoadPlayersCsv(false);
      if (!loaded) loaded = await tryLoadPlayersCsv(true);
    } else {
      // no param → local first, then remote
      loaded = await tryLoadPlayersCsv(true);
      if (!loaded) loaded = await tryLoadPlayersCsv(false);
    }

    if (loaded && TEAM_SHEETS && TEAM_SHEETS.length){
      // respect ?home=&away= if present, otherwise pick two distinct teams
      const hFromUrl = fuzzyFindTeam(URL_HOME);
      const aFromUrl = fuzzyFindTeam(URL_AWAY);

      let homeT = hFromUrl || null;
      let awayT = aFromUrl || null;

      if (!homeT && !awayT){
        [homeT, awayT] = pickTwoDistinct(TEAM_SHEETS);
      } else if (!homeT){
        homeT = TEAM_SHEETS.find(t => t !== awayT) || TEAM_SHEETS[0];
      } else if (!awayT || awayT === homeT){
        awayT = TEAM_SHEETS.find(t => t !== homeT) || TEAM_SHEETS[0];
      }

      // sync dropdowns + labels + header names
      homeTeamSel.value   = homeT;
      homeLabel.value     = homeT;
      homeName.textContent= homeT;

      awayTeamSel.value   = awayT;
      awayLabel.value     = awayT;
      awayName.textContent= awayT;

      rosterStatus.textContent = 'Loaded ' + TEAM_SHEETS.length + ' teams from CSV';
      applyStadiumFromTeams();
    } else {
      rosterStatus.textContent = 'No players.csv found — using generated players.';
    }
  } catch (e) {
    console.error('init failed:', e);
    rosterStatus.textContent = 'Roster load error — using generated players.';
  } finally {
    startBtn.disabled = false;
  }
})();


</script>

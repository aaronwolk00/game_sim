<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFL Sim — Schedule</title>
<style>
:root{--bg:#0b1220;--panel:#121a2a;--card:#0e1630;--text:#eef2ff;--muted:#93a0b1;--accent:#5eead4;--home:#4ade80;--away:#60a5fa}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:grid;place-items:center}
main{width:min(980px,94vw);display:grid;gap:16px}
h1{margin:0 0 6px;font-size:22px;letter-spacing:.2px}
.panel{background:var(--panel);border-radius:14px;padding:12px;border:1px solid #1c2440;box-shadow:0 6px 24px rgba(0,0,0,.25)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:10px;background:var(--accent);color:#0a0f17;font-weight:700;font-size:12px;border:none;box-shadow:0 2px 0 rgba(0,0,0,.25);text-decoration:none;cursor:pointer}
.btn.ghost{background:var(--card);color:#dbe3ef;border:1px solid #2a355a;box-shadow:none}
.btn.small{padding:6px 8px;border-radius:8px;font-size:11px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.small{font-size:12px;color:var(--muted)}
hr{height:1px;background:#1c2440;border:0;margin:6px 0;border-radius:2px}
.viewtabs{display:flex;gap:6px}
.viewtab{padding:6px 10px;border-radius:999px;border:1px solid #2a355a;background:#0e1630;color:#cbd5e1;cursor:pointer;font-size:12px}
.viewtab.active{background:#1e293b;color:#e5e7eb}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th,.table td{border-bottom:1px solid #1f2740;padding:8px 8px;text-align:left}
.table th{font-weight:700;color:#dbe3ef}
.right{text-align:right}
.section{background:rgba(255,255,255,.02);border:1px solid #1c2440;border-radius:12px;padding:8px;margin-top:8px}
.section h3{margin:0 0 6px;font-size:14px;display:flex;align-items:center;gap:8px}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--card);border:1px solid #233055;font-size:12px;color:#9aa6b2}
.team{font-weight:700}
.away{color:var(--away)}
.home{color:var(--home)}
.nowrap{white-space:nowrap}
.stickyhead{position:sticky;top:0;background:linear-gradient(var(--panel),var(--panel));z-index:2;border-bottom:1px solid #1f2740}
select{background:#0e1630;border:1px solid #2a355a;color:#e5e7eb;border-radius:10px;padding:6px 8px;font-size:12px}
kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e1630;border:1px solid #2a355a;border-radius:6px;padding:1px 5px;font-size:12px}
.warn{color:#fca5a5}
.score{font-weight:700}
.win{color:#86efac}
.loss{color:#fca5a5}
.simcol{width:1%;white-space:nowrap}
</style>
</head>
<body>
  <main>
    <div class="row" style="justify-content:space-between;align-items:center">
      <h1>Schedule</h1>
      <div class="row">
        <a id="toStandings" class="btn ghost">← Standings</a>
        <a id="toGames" class="btn ghost">Weekly Games</a>
        <a id="toSchedule" class="btn">Schedule</a>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="viewtabs">
          <button class="viewtab active" data-mode="week">By Week</button>
          <button class="viewtab" data-mode="team">By Team</button>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <label class="small" for="seasonSel">Season</label>
          <select id="seasonSel"></select>
          <label class="small" for="typeSel">Type</label>
          <select id="typeSel">
            <option value="REG" selected>REG</option>
            <option value="POST">POST</option>
            <option value="">All</option>
          </select>
          <span class="pill" id="gamesPill">0 games</span>
          <span class="pill" id="teamsPill">0 teams</span>
          <span class="pill" id="csvPill">CSV: loading…</span>
          <span class="pill" id="playersPill">Players: —</span>
        </div>
      </div>
      <hr>
      <div id="scheduleRoot"></div>
    </div>

    <div class="small">
      Uses nflfastR-like <kbd>team/opp/home_away</kbd> (paired by <kbd>game_id</kbd>). Sim buttons call
      <code>window.runGameHeadless(home, away, playersUrl)</code> if present; else a quick sim is used.
      Results &amp; standings persist per season in <code>localStorage</code>.
    </div>
  </main>

<!-- engine optional; quick sim fallback exists -->
<script src="engine.js"></script>
<script>
/* ---------- Params & nav ---------- */
var PARAMS = new URLSearchParams(location.search);
var RAW_PLAYERS_PARAM = (PARAMS.get('players')||'').replace('/refs/heads/','/');
var RAW_SCHEDULE_PARAM= (PARAMS.get('schedule')||'').replace('/refs/heads/','/');
var DEFAULT_SEASON = Number(PARAMS.get('season')||'2020') || 2020;

function buildQS(season){
  var p = RAW_PLAYERS_PARAM ? 'players=' + encodeURIComponent(RAW_PLAYERS_PARAM) : '';
  var s = RAW_SCHEDULE_PARAM? 'schedule=' + encodeURIComponent(RAW_SCHEDULE_PARAM) : '';
  var y = season ? 'season=' + season : '';
  var parts = [p,s,y].filter(Boolean);
  return parts.length ? ('?' + parts.join('&')) : '';
}
function wireLinks(season){
  document.getElementById('toStandings').href = 'standings.html' + buildQS(season);
  document.getElementById('toGames').href     = 'index.html' + buildQS(season);
  document.getElementById('toSchedule').href  = 'schedule.html' + buildQS(season);
}

/* ---------- Sources ---------- */
var SCHEDULE_URLS = RAW_SCHEDULE_PARAM
  ? [RAW_SCHEDULE_PARAM, new URL('schedule.csv', location.href).href]
  : [new URL('schedule.csv', location.href).href];

var PLAYERS_URLS = RAW_PLAYERS_PARAM
  ? [RAW_PLAYERS_PARAM, new URL('players.csv', location.href).href]
  : [new URL('players.csv', location.href).href];

/* ---------- DOM ---------- */
var csvPill   = document.getElementById('csvPill');
var gamesPill = document.getElementById('gamesPill');
var teamsPill = document.getElementById('teamsPill');
var playersPill = document.getElementById('playersPill');
var root      = document.getElementById('scheduleRoot');
var seasonSel = document.getElementById('seasonSel');
var typeSel   = document.getElementById('typeSel');

/* ---------- CSV helpers ---------- */
function fetchCsvFrom(urls){
  return new Promise(function(resolve,reject){
    var i=0;
    function next(){
      if(i>=urls.length){ reject(new Error('CSV not reachable')); return; }
      var url=urls[i++];
      fetch(url,{cache:'no-store',mode:'cors'})
        .then(function(r){ if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.text().then(function(t){ resolve({text:t,url:url}); }); })
        .catch(function(){ next(); });
    }
    next();
  });
}
function splitLines(t){ return String(t||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n'); }
function sniffDelimiter(line){ var cand=[',','\t',';','|']; var best=',',n=0; for(var i=0;i<cand.length;i++){var d=cand[i],k=line.split(d).length; if(k>n){best=d;n=k;}} return best; }
function splitRow(row,d){ var out=[],f='',q=false; for(var i=0;i<row.length;i++){var c=row[i]; if(q){ if(c==='"'){ if(row[i+1]==='"'){f+='"';i++;} else q=false;} else f+=c; } else { if(c==='"') q=true; else if(c===d){ out.push(f); f=''; } else f+=c; } } out.push(f); return out; }
function parseSmart(text){ var lines=splitLines(text).filter(function(l){return l.trim()!=='';}); if(!lines.length) return []; var d=sniffDelimiter(lines[0]); return lines.map(function(line){return splitRow(line,d);}); }
function rowsToObjects(rows, headerIdx){
  var header=rows[headerIdx].map(function(h){return String(h||'').trim();});
  return rows.slice(headerIdx+1).map(function(r){
    var o={}; for(var j=0;j<header.length;j++){ o[header[j]] = (r[j]===undefined?'':r[j]); } return o;
  });
}

/* ---------- Build schedule from nflfastR-style rows ---------- */
function toInt(x){ var n=parseInt(x,10); return isFinite(n)?n:NaN; }
function toWeek(x){ var n=parseInt(String(x||'').replace(/[^\d]/g,''),10); return isFinite(n)?n:1; }

function buildScheduleFromFastR(objs){
  // Group rows by game_id and pick H/A sides
  var byId = new Map();
  for(var i=0;i<objs.length;i++){
    var r=objs[i];
    var gid = String(r.game_id||'').trim();
    if(!gid) continue;
    if(!byId.has(gid)) byId.set(gid, []);
    byId.get(gid).push(r);
  }
  var out=[];
  byId.forEach(function(rows){
    // prefer explicit H/A rows
    var homeRow=null, awayRow=null;
    for(var i=0;i<rows.length;i++){
      var rr=rows[i];
      var ha = String(rr.home_away||'').trim().toUpperCase();
      if(ha==='H') homeRow=rr;
      else if(ha==='A') awayRow=rr;
    }
    if(!homeRow && rows.length) homeRow = rows.find(function(x){return String(x.home_away||'').toUpperCase()==='H';}) || rows[0];
    if(!awayRow && rows.length){
      var tmp = rows.find(function(x){return String(x.home_away||'').toUpperCase()==='A';});
      if(tmp) awayRow = tmp;
    }
    if(!homeRow || !awayRow){
      // fallback: infer using team/opp symmetry
      var r0 = rows[0];
      var t = String(r0.team||'').trim(), o=String(r0.opp||'').trim();
      var ha = String(r0.home_away||'').trim().toUpperCase();
      if(ha==='H'){ homeRow=r0; awayRow=r0; awayRow.team=o; awayRow.opp=t; }
      else { awayRow=r0; homeRow=r0; homeRow.team=o; homeRow.opp=t; }
    }
    if(!homeRow || !awayRow) return;

    var season = toInt(homeRow.season);
    var season_type = String(homeRow.season_type||'REG').toUpperCase();
    var week = toWeek(homeRow.week);
    var date = String(homeRow.date||'').trim();
    var time = '';
    var venue= '';

    var home = String(homeRow.team||'').trim();
    var away = String(awayRow.team||'').trim();

    out.push({ season:+season, season_type:season_type, week:week, date:date, time:time, venue:venue,
               home:home, away:away, gid:String(homeRow.game_id||'').trim() });
  });
  return out;
}

/* ---------- Ratings + sim ---------- */
function quickSimGame(home, away){
  // simple neutral sim; tweakable
  var drives = 12 + Math.round((Math.random()-0.5)*2);
  function side(){ var pts=0; for(var i=0;i<drives;i++){ var r=Math.random(); if(r<0.30){ pts+=6; if(Math.random()<0.94) pts+=1; } else if(r<0.48){ pts+=3; } } return pts; }
  var hp=side(), ap=side();
  if(Math.abs(hp-ap)<=2){ if(Math.random()<0.35){ (hp<=ap)?(hp+=3):(ap+=3); } }
  if(hp===ap){ (Math.random()<0.5)?(hp+=3):(ap+=3); }
  return Promise.resolve({homePts:hp,awayPts:ap});
}
function simulateGame(home, away, playersUrl){
  if (typeof window.runGameHeadless === 'function') {
    return window.runGameHeadless(home, away, playersUrl);
  }
  return quickSimGame(home, away);
}

/* ---------- Persistence ---------- */
function keysFor(season){ return { res:'sim:'+season+':results', std:'sim:'+season+':standings' }; }
function getResults(season){ try{ return JSON.parse(localStorage.getItem(keysFor(season).res)||'[]'); }catch(e){ return []; } }
function setResults(season, rows){ try{ localStorage.setItem(keysFor(season).res, JSON.stringify(rows)); }catch(e){} }
function getStandings(season){ try{ return JSON.parse(localStorage.getItem(keysFor(season).std)||'{}'); }catch(e){ return {}; } }
function setStandings(season, obj){ try{ localStorage.setItem(keysFor(season).std, JSON.stringify(obj)); }catch(e){} }
function computeStandings(season, teams, results){
  var st={}; teams.forEach(function(t){ st[t]={team:t,wins:0,losses:0,pf:0,pa:0}; });
  for(var i=0;i<results.length;i++){
    var r=results[i], home=r.Home, away=r.Away;
    var hp=Number(r.HomeScore)||0, ap=Number(r.AwayScore)||0;
    if(!st[home]) st[home]={team:home,wins:0,losses:0,pf:0,pa:0};
    if(!st[away]) st[away]={team:away,wins:0,losses:0,pf:0,pa:0};
    st[home].pf+=hp; st[home].pa+=ap; st[away].pf+=ap; st[away].pa+=hp;
    if(hp>ap){ st[home].wins++; st[away].losses++; } else { st[away].wins++; st[home].losses++; }
  }
  setStandings(season, st);
  return st;
}

/* ---------- Rendering ---------- */
function gameKey(g){ return [g.season,g.season_type,g.week,g.home,g.away,g.date].join('|'); }

function gameRowHTML(g, resultsMap){
  var meta=[g.date,g.time,g.venue].filter(Boolean).join(' • ');
  var key = gameKey(g);
  var res = resultsMap.get(key);
  var played = !!res;
  var ap = played ? (res.awayPts!==undefined?res.awayPts:res.AwayScore) : '';
  var hp = played ? (res.homePts!==undefined?res.homePts:res.HomeScore) : '';
  var score = played ? (ap+'-'+hp) : '';
  var winner = played ? (hp>ap ? g.home : g.away) : '';
  var clsAway = played && winner===g.away ? 'win' : (played ? 'loss' : '');
  var clsHome = played && winner===g.home ? 'win' : (played ? 'loss' : '');

  return '<tr data-key="'+key+'">'+
    '<td class="right nowrap">W'+g.week+'</td>'+
    '<td><span class="team away '+clsAway+'">'+g.away+'</span> @ <span class="team home '+clsHome+'">'+g.home+'</span></td>'+
    '<td class="small">'+meta+'</td>'+
    '<td class="right simcol">'+
      (played ? ('<span class="score">'+score+'</span>') : ('<button class="btn small" data-action="sim-game" data-key="'+key+'">Sim</button>'))+
    '</td>'+
  '</tr>';
}
function weekTable(weekNum,games,resultsMap){
  var unplayed = games.filter(function(g){ return !resultsMap.has(gameKey(g)); }).length;
  return '<div class="section">'+
    '<h3>Week '+weekNum+' '+(unplayed ? '<button class="btn small" data-action="sim-week" data-week="'+weekNum+'">Sim Week</button>' : '<span class="pill">All played</span>')+'</h3>'+
    '<table class="table">'+
      '<thead class="stickyhead"><tr><th class="right">Wk</th><th>Matchup</th><th>Details</th><th class="right">Sim</th></tr></thead>'+
      '<tbody>'+games.map(function(g){return gameRowHTML(g, resultsMap);}).join('')+'</tbody>'+
    '</table>'+
  '</div>';
}
function teamTable(team,list,resultsMap){
  return '<div class="section"><h3>'+team+'</h3><table class="table">'+
    '<thead class="stickyhead"><tr><th class="right">Wk</th><th>Opponent</th><th>Details</th><th class="right">Sim</th></tr></thead>'+
    '<tbody>'+list.map(function(g){
      var isHome=g.home===team; var opp=isHome?g.away:g.home; var meta=[g.date,g.time,g.venue].filter(Boolean).join(' • ');
      var key=gameKey(g); var res=resultsMap.get(key); var played=!!res;
      var hp = played ? (res.homePts!==undefined?res.homePts:res.HomeScore) : 0;
      var ap = played ? (res.awayPts!==undefined?res.awayPts:res.AwayScore) : 0;
      var score = played ? (isHome? (ap+'-'+hp) : (hp+'-'+ap)) : '';
      var win = played ? ((isHome?hp:ap) > (isHome?ap:hp)) : null;
      return '<tr data-key="'+key+'">'+
        '<td class="right nowrap">W'+g.week+'</td>'+
        '<td>'+(isHome?'vs':'@')+' <span class="team '+(win===true?'win':(win===false?'loss':''))+'">'+opp+'</span></td>'+
        '<td class="small">'+meta+'</td>'+
        '<td class="right simcol">'+(played?('<span class="score">'+score+'</span>'):'<button class="btn small" data-action="sim-game" data-key="'+key+'">Sim</button>')+'</td>'+
      '</tr>';
    }).join('')+
    '</tbody></table></div>';
}

/* ---------- State ---------- */
var RAW_SCHEDULE=[];      // all seasons
var CURRENT_SEASON=DEFAULT_SEASON;
var CURRENT_TYPE='REG';
var VIEW='week';

var PLAYERS_URL_USED = '';
var BUSY=false;

function filtered(){
  return RAW_SCHEDULE.filter(function(g){
    return Number(g.season)===Number(CURRENT_SEASON) && (!CURRENT_TYPE || g.season_type===CURRENT_TYPE);
  });
}

function render(){
  wireLinks(CURRENT_SEASON);

  var SCHEDULE = filtered();
  var results = getResults(CURRENT_SEASON);
  var resultsMap = new Map(results.map(function(r){
    var k=[r.Season,r.Type,r.Week,r.Home,r.Away,r.Date].join('|'); return [k,r];
  }));

  if(!SCHEDULE.length){
    root.innerHTML='<div class="small">No games found.</div>';
    gamesPill.textContent='0 games';
    teamsPill.textContent='0 teams';
    return;
  }

  var teamSet=new Set(); SCHEDULE.forEach(function(g){ teamSet.add(g.home); teamSet.add(g.away); });
  gamesPill.textContent=SCHEDULE.length+' games';
  teamsPill.textContent=teamSet.size+' teams';

  if(VIEW==='team'){
    var byTeam=new Map();
    SCHEDULE.forEach(function(g){
      if(!byTeam.has(g.home)) byTeam.set(g.home,[]);
      if(!byTeam.has(g.away)) byTeam.set(g.away,[]);
      byTeam.get(g.home).push(g); byTeam.get(g.away).push(g);
    });
    var names=Array.from(byTeam.keys()).sort(function(a,b){return a.localeCompare(b);});
    root.innerHTML=names.map(function(t){
      var list=byTeam.get(t).slice().sort(function(a,b){return (a.week-b.week)|| (a.home+a.away).localeCompare(b.home+b.away);});
      return teamTable(t,list,resultsMap);
    }).join('');
  }else{
    var byWeek=new Map();
    SCHEDULE.forEach(function(g){ if(!byWeek.has(g.week)) byWeek.set(g.week,[]); byWeek.get(g.week).push(g);});
    var weeks=Array.from(byWeek.keys()).sort(function(a,b){return a-b;});
    root.innerHTML=weeks.map(function(w){
      var games=byWeek.get(w).slice().sort(function(a,b){return (a.away+a.home).localeCompare(b.away+b.home);});
      return weekTable(w,games,resultsMap);
    }).join('');
  }
}

/* ---------- Boot & interactions ---------- */
(function init(){
  Array.prototype.slice.call(document.querySelectorAll('.viewtab')).forEach(function(b){
    b.addEventListener('click', function(){
      Array.prototype.slice.call(document.querySelectorAll('.viewtab')).forEach(function(x){ x.classList.remove('active'); });
      b.classList.add('active'); VIEW=b.getAttribute('data-mode'); render();
    });
  });

  // players URL (optional)
  fetchCsvFrom(PLAYERS_URLS).then(function(pr){ PLAYERS_URL_USED = pr.url; playersPill.textContent='Players: loaded'; })
    .catch(function(){ playersPill.textContent='Players: n/a'; });

  // schedule
  fetchCsvFrom(SCHEDULE_URLS).then(function(sr){
    csvPill.textContent = 'CSV: ' + (sr.url.indexOf('githubusercontent')>-1?'remote':'local');

    var rows = parseSmart(sr.text);
    if(!rows.length) throw new Error('Empty schedule.csv');

    var header = rows[0].map(function(h){return String(h||'').trim().toLowerCase();});
    var objs = rowsToObjects(rows, 0);

    // explicitly use nflfastR schema you pasted
    RAW_SCHEDULE = buildScheduleFromFastR(objs)
      .filter(function(g){ return g.home && g.away && isFinite(g.season); });

    // seasons → dropdown
    var seasons = Array.from(new Set(RAW_SCHEDULE.map(function(g){return Number(g.season);}))).sort(function(a,b){return b-a;});
    seasonSel.innerHTML = seasons.map(function(y){ return '<option value="'+y+'">'+y+'–'+String(y+1).slice(-2)+'</option>'; }).join('');
    CURRENT_SEASON = seasons.indexOf(Number(DEFAULT_SEASON))>-1 ? Number(DEFAULT_SEASON) : seasons[0];
    seasonSel.value = CURRENT_SEASON;

    seasonSel.addEventListener('change', function(){ CURRENT_SEASON = Number(seasonSel.value)||seasons[0]; render(); });
    typeSel.addEventListener('change', function(){ CURRENT_TYPE = typeSel.value; render(); });

    // sim actions
    root.addEventListener('click', function(ev){
      var btn = ev.target.closest ? ev.target.closest('button[data-action]') : null;
      if(!btn || BUSY) return;
      var action = btn.getAttribute('data-action');
      if(action==='sim-game'){
        var key = btn.getAttribute('data-key');
        var g = filtered().find(function(x){ return gameKey(x)===key; });
        if(!g) return;
        runOneGame(g).then(render);
      }
      if(action==='sim-week'){
        var wk = Number(btn.getAttribute('data-week'));
        var list = filtered().filter(function(g){ return g.week===wk; });
        (function loop(i){
          if(i>=list.length){ render(); return; }
          var g=list[i];
          var already = getResults(CURRENT_SEASON).some(function(r){
            return [r.Season,r.Type,r.Week,r.Home,r.Away,r.Date].join('|') === gameKey(g);
          });
          if(already){ loop(i+1); return; }
          runOneGame(g).then(function(){ loop(i+1); });
        })(0);
      }
    });

    wireLinks(CURRENT_SEASON);
    CURRENT_TYPE = typeSel.value;
    render();
  }).catch(function(e){
    console.error(e);
    csvPill.textContent='CSV: error';
    root.innerHTML='<div class="small warn">Could not load <code>schedule.csv</code>. Place it next to this file or pass <code>?schedule=</code>.</div>';
  });
})();

/* ---------- One game executor ---------- */
function runOneGame(g){
  BUSY=true;
  return new Promise(function(resolve){
    simulateGame(g.home, g.away, PLAYERS_URL_USED).then(function(res){
      var hp = Number(res && res.homePts); if(!isFinite(hp)) hp = 0;
      var ap = Number(res && res.awayPts); if(!isFinite(ap)) ap = 0;

      var rec = { Season:g.season, Type:g.season_type, Week:g.week, Date:g.date, Time:g.time,
                  Away:g.away, Home:g.home, AwayScore:ap, HomeScore:hp,
                  awayPts:ap, homePts:hp, Winner: (hp>ap?g.home:g.away) };

      var cur = getResults(g.season);
      var key = gameKey(g);
      var idx = -1; for(var i=0;i<cur.length;i++){ var r=cur[i]; if([r.Season,r.Type,r.Week,r.Home,r.Away,r.Date].join('|')===key){ idx=i; break; } }
      if(idx>=0) cur[idx]=rec; else cur.push(rec);
      setResults(g.season, cur);

      var teams = Array.from(new Set([].concat.apply([], filtered().map(function(x){return [x.home,x.away];}))));
      computeStandings(g.season, teams, cur);

      BUSY=false; resolve();
    }).catch(function(e){ console.error(e); BUSY=false; resolve(); });
  });
}
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFL Sim — Weekly Games</title>
<style>
:root{--bg:#0b1220;--panel:#121a2a;--card:#0e1630;--text:#eef2ff;--muted:#93a0b1;--accent:#5eead4}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:grid;place-items:center}
main{width:min(980px,94vw);display:grid;gap:16px}
h1{margin:0 0 6px;font-size:22px;letter-spacing:.2px}
.panel{background:var(--panel);border-radius:14px;padding:12px;border:1px solid #1c2440;box-shadow:0 6px 24px rgba(0,0,0,.25)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:10px;background:var(--accent);color:#0a0f17;font-weight:700;font-size:12px;border:none;box-shadow:0 2px 0 rgba(0,0,0,.25);text-decoration:none;cursor:pointer}
.btn.ghost{background:var(--card);color:#dbe3ef;border:1px solid #2a355a;box-shadow:none}
.small{font-size:12px;color:var(--muted)}
hr{height:1px;background:#1c2440;border:0;margin:6px 0;border-radius:2px}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th,.table td{border-bottom:1px solid #1f2740;padding:8px 8px;text-align:left}
.table th{font-weight:700;color:#dbe3ef}
.right{text-align:right}
select{background:#0e1630;border:1px solid #2a355a;color:#e5e7eb;border-radius:10px;padding:6px 8px;font-size:12px}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--card);border:1px solid #233055;font-size:12px;color:#9aa6b2}
.win{color:#86efac;font-weight:700}
.loss{color:#fca5a5;font-weight:700}
</style>
</head>
<body>
  <main>
    <div class="row" style="justify-content:space-between;align-items:center">
      <h1>Weekly Games</h1>
      <div class="row">
        <a id="toStandings" class="btn ghost">Standings</a>
        <a id="toSchedule" class="btn">Schedule</a>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:8px;align-items:center">
          <label class="small" for="seasonSel">Season</label>
          <select id="seasonSel"></select>
          <label class="small" for="typeSel">Type</label>
          <select id="typeSel">
            <option value="REG" selected>REG</option>
            <option value="POST">POST</option>
            <option value="">All</option>
          </select>
          <label class="small" for="weekSel">Week</label>
          <select id="weekSel"></select>
          <span class="pill" id="gamesPill">0 games</span>
          <span class="pill" id="csvPill">CSV: loading…</span>
        </div>
      </div>
      <hr>
      <div id="root"></div>
    </div>

    <div class="small">Scores reflect what you’ve simmed in <code>schedule.html</code> (live).</div>
  </main>

<script>
const PARAMS = new URLSearchParams(location.search);
const RAW_SCHEDULE_PARAM= (PARAMS.get('schedule')||'').replace('/refs/heads/','/');
const DEFAULT_SEASON = Number(PARAMS.get('season')||'2020')||2020;
function buildQS(season){ const s=RAW_SCHEDULE_PARAM?`schedule=${encodeURIComponent(RAW_SCHEDULE_PARAM)}`:''; const y=season?`season=${season}`:''; const parts=[s,y].filter(Boolean); return parts.length?`?${parts.join('&')}`:''; }
function wireLinks(season){ document.getElementById('toStandings').href=`standings.html${buildQS(season)}`; document.getElementById('toSchedule').href=`schedule.html${buildQS(season)}`; }

const SCHEDULE_URLS = RAW_SCHEDULE_PARAM? [RAW_SCHEDULE_PARAM, new URL('schedule.csv', location.href).href] : [new URL('schedule.csv', location.href).href];

const seasonSel=document.getElementById('seasonSel');
const typeSel=document.getElementById('typeSel');
const weekSel=document.getElementById('weekSel');
const gamesPill=document.getElementById('gamesPill');
const csvPill=document.getElementById('csvPill');
const root=document.getElementById('root');

async function fetchCsvFrom(urls){ let lastErr=null; for(const url of urls){ try{
  const res=await fetch(url,{cache:'no-store',mode:'cors'}); if(!res.ok) throw new Error(`${res.status} ${res.statusText}`); return {text:await res.text(), url}; }catch(e){ lastErr=e; } } throw lastErr||new Error('CSV not reachable'); }
function splitLines(t){ return String(t||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n'); }
function sniffDelimiter(line){ const c=[',','\t',';','|']; let b=',',n=0; for(const d of c){const k=line.split(d).length; if(k>n){b=d;n=k;}} return b;}
function splitRow(row,d){ const out=[]; let f='',q=false; for(let i=0;i<row.length;i++){const c=row[i]; if(q){ if(c==='"'){ if(row[i+1]==='"'){f+='"';i++;} else q=false;} else f+=c; } else { if(c==='"') q=true; else if(c===d){ out.push(f); f=''; } else f+=c; } } out.push(f); return out; }
function parseSmart(text){ const lines=splitLines(text).filter(l=>l.trim()!==''); if(!lines.length) return []; const d=sniffDelimiter(lines[0]); return lines.map(line=>splitRow(line,d)); }
const lc=s=>String(s||'').trim().toLowerCase();
function findHeaderIndex(rows){ const wants=[['home','away'],['home team','away team'],['home_team','away_team'],['team_home','team_away'],['home_team_abbr','away_team_abbr'],['team','opp']]; for(let i=0;i<Math.min(20,rows.length);i++){ const r=rows[i].map(lc); for(const w of wants){ if(w.every(x=>r.includes(x))) return i; } } return 0; }
function rowsToObjects(rows,i){ const h=rows[i].map(x=>String(x||'').trim()); return rows.slice(i+1).map(r=>{const o={}; h.forEach((k,j)=>o[k]= r[j]===undefined?'':r[j]); return o;}); }
function toWeek(x){ const n=parseInt(String(x||'').replace(/[^\d]/g,''),10); return Number.isFinite(n)?n:1; }
const toSeasonNum=v=>{ const n=Number.parseInt(String(v||'').trim(),10); return Number.isFinite(n)?n:NaN; };
function mapDirectRow(r){
  const home=r.Home||r.home||r['Home Team']||r['home_team']||r['team_home']||r['home_team_abbr']||'';
  const away=r.Away||r.away||r['Away Team']||r['away_team']||r['team_away']||r['away_team_abbr']||'';
  const wk=r.Week||r.week||r.Wk||''; const date=r.Date||r.date||r.gameday||r.game_date||''; const time=r.Time||r.time||r.game_time_eastern||''; const venue=r.Venue||r.venue||r.Stadium||r.site||'';
  let season=toSeasonNum(r.season||r.Season); if(!Number.isFinite(season)){ const y=+String(date).slice(0,4); if(Number.isFinite(y)) season=y; }
  const season_type=String(r.season_type||r.Season_Type||'').toUpperCase()||'REG';
  return {season:+season, season_type, week:toWeek(wk), home:String(home).trim(), away:String(away).trim(), date:String(date).trim(), time:String(time).trim(), venue:String(venue).trim()};
}
function buildFromTeamOpp(objs){
  const getHA=r=>{const s=String(r.home_away||r.homeaway||r.ha||'').trim().toUpperCase(); if(['H','HOME','1','TRUE'].includes(s))return'H'; if(['A','AWAY','@','0','FALSE'].includes(s))return'A'; return'';};
  const keyFor=r=>{const rid=String(r.row_id||'').trim(); const gid=String(r.game_id||'').trim()||(rid.includes(':')?rid.split(':')[0]:''); if(gid) return gid;
    const season=r.season||''; const wk=r.week||''; const date=r.date||''; const t=(r.team||'').trim(); const o=(r.opp||'').trim();
    return `${season}|${wk}|${date}|${[t,o].sort().join('@')}`;};
  const byKey=new Map(); for(const r of objs){ const t=String(r.team||'').trim(); const o=String(r.opp||'').trim(); if(!t||!o) continue; const k=keyFor(r); if(!byKey.has(k)) byKey.set(k,[]); byKey.get(k).push(r); }
  const out=[]; for(const rows of byKey.values()){
    const r0=rows[0]; const week=toWeek(r0.week||r0.Week); const date=String(r0.date||'').trim(); const time=String(r0.game_time_eastern||r0.time||'').trim(); const venue=String(r0.venue||r.site||r.Stadium||'').trim();
    let season=toSeasonNum(r0.season||r0.Season); if(!Number.isFinite(season)){ const y=+String(date).slice(0,4); if(Number.isFinite(y)) season=y; }
    const season_type=String(r0.season_type||r0.Season_Type||'').toUpperCase()||'REG';
    let home='',away=''; const h=rows.find(rr=>getHA(rr)==='H'); if(h){home=String(h.team).trim(); away=String(h.opp).trim();} else if(rows.length===1){ const rr=r0; const ha=getHA(rr); if(ha==='H'){home=String(rr.team).trim(); away=String(rr.opp).trim();} else {home=String(rr.opp).trim(); away=String(rr.team).trim();}}
    else { const A=rows[0],B=rows[1]; home=String(A.team).trim(); away=String(A.opp||B.team).trim(); }
    if(home&&away) out.push({season:+season, season_type, week, home, away, date, time, venue});
  } return out;
}

let RAW_SCHEDULE=[]; let CURRENT_SEASON=DEFAULT_SEASON; let CURRENT_TYPE='REG'; let CURRENT_WEEK=1; let chan=null;
function getResults(season){ try{ return JSON.parse(localStorage.getItem(`sim:${season}:results`)||'[]'); }catch(e){ return []; } }
function keyFor(g){ return `${g.season}|${g.season_type}|${g.week}|${g.home}|${g.away}|${g.date}`; }

function render(){
  wireLinks(CURRENT_SEASON);
  const all = RAW_SCHEDULE.filter(g => g.season===CURRENT_SEASON && (!CURRENT_TYPE || g.season_type===CURRENT_TYPE));
  const weeks = [...new Set(all.map(g=>g.week))].sort((a,b)=>a-b);
  if(!weeks.includes(CURRENT_WEEK)) CURRENT_WEEK = weeks[0]||1;
  weekSel.innerHTML = weeks.map(w=>`<option value="${w}">W${w}</option>`).join('');
  weekSel.value = CURRENT_WEEK;

  const list = all.filter(g=>g.week===CURRENT_WEEK).sort((a,b)=>(a.away+a.home).localeCompare(b.away+b.home));
  const results = getResults(CURRENT_SEASON);
  const resMap = new Map(results.map(r => [`${r.Season}|${r.Type}|${r.Week}|${r.Home}|${r.Away}|${r.Date}`, r]));
  gamesPill.textContent = `${list.length} games`;

  root.innerHTML = `
    <table class="table">
      <thead><tr><th class="right">Wk</th><th>Matchup</th><th>Details</th><th class="right">Score</th></tr></thead>
      <tbody>
        ${list.map(g=>{
          const r = resMap.get(keyFor(g));
          const played = !!r;
          const sc = played ? `${r.AwayScore}-${r.HomeScore}` : '—';
          const awayCls = played ? (r.AwayScore>r.HomeScore?'win':'loss') : '';
          const homeCls = played ? (r.HomeScore>r.AwayScore?'win':'loss') : '';
          const meta=[g.date,g.time,g.venue].filter(Boolean).join(' • ');
          return `<tr>
            <td class="right">W${g.week}</td>
            <td><span class="${awayCls}">${g.away}</span> @ <span class="${homeCls}">${g.home}</span></td>
            <td class="small">${meta}</td>
            <td class="right">${sc}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;
}

(async function init(){
  try{
    const {text,url}=await fetchCsvFrom(SCHEDULE_URLS);
    csvPill.textContent=`CSV: ${url.includes('githubusercontent')?'remote':'local'}`;
    const rows=parseSmart(text); const hi=findHeaderIndex(rows);
    const header=rows[hi].map(h=>String(h||'').trim().toLowerCase());
    const objs=rowsToObjects(rows,hi);
    RAW_SCHEDULE = header.includes('team') && header.includes('opp') ? buildFromTeamOpp(objs) : objs.map(mapDirectRow);
    RAW_SCHEDULE.forEach(g=>g.season=Number(g.season));

    const seasons=[...new Set(RAW_SCHEDULE.map(g=>g.season).filter(Number.isFinite))].sort((a,b)=>b-a);
    seasonSel.innerHTML = seasons.map(y=>`<option value="${y}">${y}–${String(y+1).slice(-2)}</option>`).join('');
    CURRENT_SEASON = seasons.includes(Number(DEFAULT_SEASON)) ? Number(DEFAULT_SEASON) : seasons[0];
    seasonSel.value = CURRENT_SEASON;

    seasonSel.addEventListener('change',()=>{ CURRENT_SEASON=Number(seasonSel.value)||seasons[0]; if(chan) try{chan.close();}catch(e){}; chan=new BroadcastChannel(`nfl-sim-${CURRENT_SEASON}`); chan.onmessage=()=>render(); render(); });
    typeSel.addEventListener('change',()=>{ CURRENT_TYPE=typeSel.value; render(); });
    weekSel.addEventListener('change',()=>{ CURRENT_WEEK=Number(weekSel.value)||CURRENT_WEEK; render(); });

    chan = new BroadcastChannel(`nfl-sim-${CURRENT_SEASON}`);
    chan.onmessage = ()=> render();

    wireLinks(CURRENT_SEASON);
    CURRENT_TYPE = typeSel.value;
    render();
  }catch(e){
    console.error(e);
    csvPill.textContent='CSV: error';
    root.innerHTML = `<div class="small">Could not load <code>schedule.csv</code>.</div>`;
  }
})();
</script>
</body>
</html>

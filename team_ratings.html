<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Layer 3 – Team Ratings Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: rgba(15, 23, 42, 0.92);
      --bg-elevated-soft: rgba(15, 23, 42, 0.75);
      --border-subtle: #1f2937;
      --border-strong: #4b5563;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.16);
      --accent-strong: #22c55e;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.16);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
      --shadow-subtle: 0 10px 25px rgba(15, 23, 42, 0.85);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-sans);
      background:
        radial-gradient(circle at top, rgba(37, 99, 235, 0.18), transparent 55%),
        radial-gradient(circle at bottom, rgba(16, 185, 129, 0.14), transparent 55%),
        var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 32px 16px;
    }

    main {
      width: 100%;
      max-width: 1320px;
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.3), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(22, 163, 74, 0.3), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      border-radius: 32px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow-soft);
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    main::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at top center, rgba(148, 163, 184, 0.12), transparent 60%),
        linear-gradient(to bottom right, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.96));
      mix-blend-mode: soft-light;
      pointer-events: none;
      z-index: -1;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .subtitle {
      margin-top: 4px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
      margin-bottom: 16px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .status-pill {
      align-self: flex-start;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .status-pill[data-state="loading"] .status-dot {
      background: #facc15;
      box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.2);
    }

    .status-pill[data-state="error"] {
      border-color: rgba(248, 113, 113, 0.7);
      background: rgba(15, 23, 42, 0.9);
    }

    .status-pill[data-state="error"] .status-dot {
      background: var(--danger);
      box-shadow: 0 0 0 3px var(--danger-soft);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
    }

    .team-select {
      min-width: 220px;
      appearance: none;
      padding: 8px 32px 8px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.55);
      background:
        radial-gradient(circle at top left, rgba(148, 163, 184, 0.12), transparent 55%),
        rgba(15, 23, 42, 0.94);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      position: relative;
    }

    .team-select:focus-visible {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }

    .btn {
      padding: 8px 14px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: linear-gradient(to bottom right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      color: var(--text-main);
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      text-decoration: none;
      transition: border-color 0.12s ease, background 0.12s ease,
        transform 0.08s ease, box-shadow 0.12s ease, color 0.12s ease;
      box-shadow: var(--shadow-subtle);
      white-space: nowrap;
    }

    .btn span.icon {
      font-size: 13px;
      opacity: 0.9;
    }

    .btn:hover:not(:disabled) {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.16), transparent 60%),
                  linear-gradient(to bottom right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.92));
      transform: translateY(-0.5px);
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.9);
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .btn-primary {
      border-color: var(--accent);
      background: radial-gradient(circle at top, rgba(34, 197, 94, 0.24), transparent 60%),
                  linear-gradient(to right, rgba(16, 185, 129, 0.9), rgba(34, 197, 94, 0.9));
      color: #022c22;
      font-weight: 500;
    }

    .btn-primary:hover:not(:disabled) {
      background: radial-gradient(circle at top, rgba(74, 222, 128, 0.3), transparent 60%),
                  linear-gradient(to right, rgba(22, 163, 74, 0.95), rgba(34, 197, 94, 0.98));
      color: #022c22;
    }

    .summary-bar {
      margin-bottom: 16px;
      padding: 10px 12px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), transparent 60%),
                  radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.95), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px 12px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .summary-label {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
    }

    .summary-main {
      color: #e5e7eb;
    }

    .summary-source {
      margin-left: auto;
      opacity: 0.85;
      font-style: italic;
    }

    .error-box {
      display: none;
      margin-bottom: 16px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: var(--danger-soft);
      color: #fecaca;
      font-size: 13px;
    }

    .error-box strong {
      font-weight: 600;
    }

    .layout-main {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .team-meta-panel {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.5);
      background:
        radial-gradient(circle at top left, rgba(55, 65, 81, 0.42), transparent 60%),
        radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.96), transparent 55%),
        rgba(15, 23, 42, 0.96);
      box-shadow: var(--shadow-subtle);
      padding: 14px 16px;
      display: none;
    }

    .team-meta-top {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
    }

    .team-meta-name-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .team-meta-name {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .team-meta-id {
      font-size: 12px;
      color: var(--text-soft);
    }

    .team-meta-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .team-meta-stat {
      min-width: 90px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .team-meta-stat-label {
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-soft);
      font-size: 10px;
    }

    .team-meta-stat-value {
      font-weight: 600;
      color: #e5e7eb;
    }

    .team-meta-positions {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed rgba(148, 163, 184, 0.35);
      font-size: 12px;
      color: var(--text-soft);
    }

    .team-meta-positions strong {
      color: var(--text-main);
      font-weight: 500;
    }

    .groups-container {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .group-card {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.38);
      background:
        radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), transparent 60%),
        rgba(15, 23, 42, 0.98);
      box-shadow: var(--shadow-subtle);
      padding: 10px 12px 12px;
    }

    .group-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .group-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(229, 231, 235, 0.9);
    }

    .group-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .group-meta-pill {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.9);
    }

    .group-meta-pill strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    .group-table-wrapper {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: rgba(15, 23, 42, 0.96);
      overflow-x: auto;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.9);
    }

    .group-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 640px;
      font-size: 11px;
      white-space: nowrap;
    }

    .group-table thead {
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.9), transparent 65%),
                  rgba(15, 23, 42, 0.98);
    }

    .group-table th,
    .group-table td {
      padding: 5px 10px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      border-right: 1px solid rgba(31, 41, 55, 0.85);
      text-align: left;
    }

    .group-table th:last-child,
    .group-table td:last-child {
      border-right: none;
    }

    .group-table th {
      position: sticky;
      top: 0;
      z-index: 1;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 10px;
      color: rgba(156, 163, 175, 0.9);
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.9), transparent 65%),
                  rgba(15, 23, 42, 0.98);
    }

    .group-table tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.97);
    }

    .group-table tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.96);
    }

    .group-table tbody tr:hover {
      background: rgba(17, 24, 39, 0.92);
    }

    .group-table td.numeric {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .group-table td.core {
      font-weight: 500;
    }

    .group-table td.name-cell {
      color: #e5e7eb;
    }

    .group-table td.name-cell span {
      color: var(--text-soft);
      font-weight: 400;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-left: 6px;
    }

    .hint-row {
      margin-top: 4px;
      font-size: 10px;
      color: rgba(156, 163, 175, 0.85);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .hint-row span {
      opacity: 0.9;
    }

    @media (max-width: 900px) {
      main {
        padding: 20px;
      }
      .top-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .controls-row {
        width: 100%;
      }
      .controls-row .team-select {
        flex: 1 1 100%;
      }
      .team-meta-top {
        flex-direction: column;
        align-items: flex-start;
      }
      .summary-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .summary-source {
        margin-left: 0;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 16px 8px;
      }
      main {
        padding: 16px;
        border-radius: 20px;
      }
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <main>
    <div class="top-row">
      <div class="title-block">
        <h1>Layer 3 – Team Ratings Explorer</h1>
        <div class="subtitle">
          Full per-team rating grid, organized by position group.
        </div>
        <div id="status-pill" class="status-pill" data-state="loading">
          <span class="status-dot"></span>
          <span id="status-text">Loading team ratings…</span>
        </div>
      </div>
      <div class="controls-row">
        <select id="team-select" class="team-select">
          <option value="">Loading teams…</option>
        </select>
        <button id="clear-team-btn" class="btn" disabled>
          <span class="icon">✕</span>Clear
        </button>
        <a id="back-link" class="btn btn-primary" href="#">
          <span class="icon">↩</span>Back to roster list
        </a>
      </div>
    </div>

    <div class="summary-bar">
      <span class="summary-label">Overview</span>
      <span id="summary-main" class="summary-main">
        Loading CSV and building team map…
      </span>
      <span id="summary-source" class="summary-source">
        Source: layer3_rosters.csv
      </span>
    </div>

    <div id="error-box" class="error-box"></div>

    <div class="layout-main">
      <section id="team-meta" class="team-meta-panel"></section>
      <section id="groups-container" class="groups-container"></section>
      <div class="hint-row">
        <span>Tip: tables are horizontally scrollable – you can drag or shift-scroll to explore all rating columns.</span>
        <span>Filters: currently scoped by team; you can extend this page later with player search or rating filters.</span>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const urlParams = new URLSearchParams(window.location.search);
      const RAW_PLAYERS_PARAM = urlParams.get("players");
      const DEFAULT_LAYER3_URL =
        "https://raw.githubusercontent.com/aaronwolk00/game_sim/main/layer3_rosters.csv";
      const EFFECTIVE_CSV_URL = RAW_PLAYERS_PARAM || DEFAULT_LAYER3_URL;

      const dom = {
        statusPill: document.getElementById("status-pill"),
        statusText: document.getElementById("status-text"),
        summaryMain: document.getElementById("summary-main"),
        summarySource: document.getElementById("summary-source"),
        errorBox: document.getElementById("error-box"),
        teamMeta: document.getElementById("team-meta"),
        groupsContainer: document.getElementById("groups-container"),
        teamSelect: document.getElementById("team-select"),
        clearTeamBtn: document.getElementById("clear-team-btn"),
        backLink: document.getElementById("back-link"),
      };

      const POSITION_GROUPS = {
        QB: "Quarterbacks",
        RB: "Running Backs",
        FB: "Fullbacks",
        WR: "Wide Receivers",
        TE: "Tight Ends",
        LT: "Offensive Line",
        LG: "Offensive Line",
        C: "Offensive Line",
        RG: "Offensive Line",
        RT: "Offensive Line",
        OL: "Offensive Line",
        DT: "Defensive Line",
        DL: "Defensive Line",
        EDGE: "Edge Rushers",
        DE: "Defensive Line",
        NT: "Defensive Line",
        LB: "Linebackers",
        CB: "Cornerbacks",
        S: "Safeties",
        FS: "Safeties",
        SS: "Safeties",
        K: "Specialists",
        P: "Specialists",
        LS: "Specialists",
      };

      const GROUP_NAME_ORDER = [
        "Quarterbacks",
        "Running Backs",
        "Fullbacks",
        "Wide Receivers",
        "Tight Ends",
        "Offensive Line",
        "Defensive Line",
        "Edge Rushers",
        "Linebackers",
        "Cornerbacks",
        "Safeties",
        "Specialists",
        "Other",
      ];

      let gAllRows = [];
      let gTeams = [];
      let gAllRatingColumns = [];

      function setStatus(state, message) {
        dom.statusPill.dataset.state = state;
        dom.statusText.textContent = message;
      }

      function showError(message, detail) {
        dom.errorBox.style.display = "block";
        dom.errorBox.innerHTML =
          "<strong>Load error:</strong> " +
          message +
          (detail ? "<br><small>" + detail + "</small>" : "");
        setStatus("error", "Error loading team ratings");
      }

      function hideError() {
        dom.errorBox.style.display = "none";
      }

      async function fetchCsvText(url) {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status + " – " + res.statusText);
        }
        return await res.text();
      }

      function parseCsvToRows(text) {
        const lines = text
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter((line) => line.length > 0);
        return lines.map((line) => line.split(","));
      }

      function rowsToObjectsWithDedupHeader(rows) {
        if (!rows.length) return [];
        const headerRaw = rows[0];
        const seen = {};
        const header = headerRaw.map((name) => {
          let key = name.trim();
          if (!key) key = "col";
          if (seen[key] == null) {
            seen[key] = 0;
            return key;
          }
          seen[key] += 1;
          return key + "_" + seen[key];
        });

        return rows.slice(1).map((cells) => {
          const obj = {};
          header.forEach((key, idx) => {
            obj[key] = cells[idx] == null ? "" : cells[idx];
          });
          return obj;
        });
      }

      function buildTeamsFromRows(objs) {
        const byId = new Map();
        for (const row of objs) {
          const teamId = (row.team_id || "").trim();
          const teamName = (row.team_name || "").trim();
          if (!teamId && !teamName) continue;

          const key = teamId || teamName;
          let team = byId.get(key);
          if (!team) {
            team = {
              teamId,
              teamName,
              key,
              players: [],
            };
            byId.set(key, team);
          }
          team.players.push(row);
        }
        return Array.from(byId.values()).sort((a, b) => {
          const nameA = a.teamName || a.teamId || "";
          const nameB = b.teamName || b.teamId || "";
          return nameA.localeCompare(nameB);
        });
      }

      function getPositionGroupLabel(pos) {
        const p = (pos || "").toUpperCase();
        return POSITION_GROUPS[p] || "Other";
      }

      function formatRating(value) {
        if (value == null || value === "") return "";
        const num = Number(value);
        if (!Number.isFinite(num)) return String(value);
        return Math.round(num);
      }

      function computeRatingColumns(objs) {
        if (!objs.length) return [];
        const headers = Object.keys(objs[0]);
        const core = ["rating_overall", "rating_pos"];
        const ratingCols = headers.filter((h) => {
          if (core.includes(h)) return true;
          return h.startsWith("rating_");
        });
        const extra = ratingCols
          .filter((h) => !core.includes(h))
          .sort((a, b) => a.localeCompare(b));
        return [...core, ...extra];
      }

      function prettifyRatingHeader(key) {
        if (key === "rating_overall") return "Ovr";
        if (key === "rating_pos") return "Pos Rt";

        let rest = key.replace(/^rating_/, "");
        if (!rest) return key;
        const parts = rest.split("_");
        const allUpper = parts.every((p) => p === p.toUpperCase());
        if (allUpper) return rest;
        return parts
          .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
          .join(" ");
      }

      function renderTeamOptions(teams) {
        dom.teamSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Select a team…";
        dom.teamSelect.appendChild(placeholder);

        for (const team of teams) {
          const opt = document.createElement("option");
          const displayName = team.teamName || team.teamId || "(Unnamed)";
          const tag = team.teamId ? team.teamId : "";
          opt.value = team.key;
          opt.textContent = tag ? `${displayName} (${tag})` : displayName;
          dom.teamSelect.appendChild(opt);
        }

        dom.teamSelect.disabled = teams.length === 0;
      }

      function renderTeamMeta(team) {
        const players = team.players || [];
        if (!players.length) {
          dom.teamMeta.style.display = "none";
          dom.teamMeta.innerHTML = "";
          return;
        }

        const overalls = players
          .map((p) => Number(p.rating_overall))
          .filter((n) => Number.isFinite(n));

        const avgOvr =
          overalls.length > 0
            ? overalls.reduce((a, b) => a + b, 0) / overalls.length
            : null;
        const minOvr =
          overalls.length > 0 ? Math.min(...overalls) : null;
        const maxOvr =
          overalls.length > 0 ? Math.max(...overalls) : null;

        const posCounts = {};
        for (const p of players) {
          const pos = (p.position || "").toUpperCase();
          if (!pos) continue;
          posCounts[pos] = (posCounts[pos] || 0) + 1;
        }
        const posSummary = Object.entries(posCounts)
          .sort((a, b) => a[0].localeCompare(b[0]))
          .map(([pos, count]) => `${pos}×${count}`)
          .join(", ");

        const displayName = team.teamName || team.teamId || "(Unnamed)";
        const idLabel = team.teamId || "—";

        dom.teamMeta.style.display = "block";
        dom.teamMeta.innerHTML = `
          <div class="team-meta-top">
            <div class="team-meta-name-block">
              <div class="team-meta-name">${displayName}</div>
              <div class="team-meta-id">Team ID: ${idLabel}</div>
            </div>
            <div class="team-meta-stats">
              <div class="team-meta-stat">
                <div class="team-meta-stat-label">Players</div>
                <div class="team-meta-stat-value">${players.length}</div>
              </div>
              <div class="team-meta-stat">
                <div class="team-meta-stat-label">Avg overall</div>
                <div class="team-meta-stat-value">
                  ${avgOvr != null ? formatRating(avgOvr) : "—"}
                </div>
              </div>
              <div class="team-meta-stat">
                <div class="team-meta-stat-label">Min / Max Ovr</div>
                <div class="team-meta-stat-value">
                  ${
                    minOvr != null && maxOvr != null
                      ? formatRating(minOvr) + " – " + formatRating(maxOvr)
                      : "—"
                  }
                </div>
              </div>
            </div>
          </div>
          <div class="team-meta-positions">
            <strong>Position mix:</strong>
            ${posSummary || "No position data available."}
          </div>
        `;
      }

      function buildGroupsForTeam(players) {
        const map = new Map();
        for (const p of players) {
          const pos = (p.position || "").toUpperCase();
          const groupName = getPositionGroupLabel(pos);
          if (!map.has(groupName)) {
            map.set(groupName, []);
          }
          map.get(groupName).push(p);
        }
        let groups = Array.from(map.entries()).map(([name, players]) => ({
          name,
          players,
        }));

        groups.forEach((g) => {
          g.players.sort((a, b) => {
            const depthA = Number(a.depth);
            const depthB = Number(b.depth);
            if (Number.isFinite(depthA) && Number.isFinite(depthB)) {
              if (depthA !== depthB) return depthA - depthB;
            }
            const ovrA = Number(a.rating_overall);
            const ovrB = Number(b.rating_overall);
            if (Number.isFinite(ovrA) && Number.isFinite(ovrB)) {
              return ovrB - ovrA;
            }
            const nameA =
              (a.last_name || "") + ", " + (a.first_name || "");
            const nameB =
              (b.last_name || "") + ", " + (b.first_name || "");
            return nameA.localeCompare(nameB);
          });
        });

        groups.sort((a, b) => {
          const idxA = GROUP_NAME_ORDER.indexOf(a.name);
          const idxB = GROUP_NAME_ORDER.indexOf(b.name);
          const normA = idxA === -1 ? GROUP_NAME_ORDER.length + 1 : idxA;
          const normB = idxB === -1 ? GROUP_NAME_ORDER.length + 1 : idxB;
          if (normA !== normB) return normA - normB;
          return a.name.localeCompare(b.name);
        });

        return groups;
      }

      function renderGroupsForTeam(team) {
        const players = team.players || [];
        dom.groupsContainer.innerHTML = "";

        if (!players.length) {
          const empty = document.createElement("div");
          empty.textContent = "No players found for this team.";
          empty.style.fontSize = "13px";
          empty.style.color = "var(--text-soft)";
          dom.groupsContainer.appendChild(empty);
          return;
        }

        const groups = buildGroupsForTeam(players);

        for (const group of groups) {
          const card = document.createElement("section");
          card.className = "group-card";

          const header = document.createElement("div");
          header.className = "group-header";

          const title = document.createElement("div");
          title.className = "group-title";
          title.textContent = group.name;

          const meta = document.createElement("div");
          meta.className = "group-meta";

          const countPill = document.createElement("div");
          countPill.className = "group-meta-pill";
          const countLabel = group.players.length === 1 ? "player" : "players";
          countPill.innerHTML =
            "<strong>" + group.players.length + "</strong> " + countLabel;

          const ovrValues = group.players
            .map((p) => Number(p.rating_overall))
            .filter((n) => Number.isFinite(n));
          if (ovrValues.length) {
            const avg =
              ovrValues.reduce((a, b) => a + b, 0) / ovrValues.length;
            const range =
              formatRating(Math.min(...ovrValues)) +
              " – " +
              formatRating(Math.max(...ovrValues));
            const statPill = document.createElement("div");
            statPill.className = "group-meta-pill";
            statPill.innerHTML =
              "<strong>Ovr:</strong> " +
              formatRating(avg) +
              " avg; " +
              range;
            meta.appendChild(statPill);
          }

          meta.appendChild(countPill);
          header.appendChild(title);
          header.appendChild(meta);

          const wrapper = document.createElement("div");
          wrapper.className = "group-table-wrapper";

          const table = document.createElement("table");
          table.className = "group-table";

          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");

          const baseCols = [
            { key: "position", label: "Pos" },
            { key: "depth", label: "Depth" },
            { key: "first_name", label: "First" },
            { key: "last_name", label: "Last" },
          ];

          for (const col of baseCols) {
            const th = document.createElement("th");
            th.textContent = col.label;
            headRow.appendChild(th);
          }

          for (const key of gAllRatingColumns) {
            const th = document.createElement("th");
            th.textContent = prettifyRatingHeader(key);
            headRow.appendChild(th);
          }

          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");

          for (const p of group.players) {
            const tr = document.createElement("tr");

            const posCell = document.createElement("td");
            posCell.textContent = (p.position || "").toUpperCase();
            posCell.className = "core";
            tr.appendChild(posCell);

            const depthCell = document.createElement("td");
            depthCell.textContent = p.depth || "";
            depthCell.className = "numeric";
            tr.appendChild(depthCell);

            const firstCell = document.createElement("td");
            firstCell.textContent = p.first_name || "";
            tr.appendChild(firstCell);

            const lastCell = document.createElement("td");
            lastCell.className = "name-cell";
            lastCell.textContent = p.last_name || "";
            if (p.primary_archetype) {
              const span = document.createElement("span");
              span.textContent = p.primary_archetype;
              lastCell.appendChild(span);
            }
            tr.appendChild(lastCell);

            for (const key of gAllRatingColumns) {
              const td = document.createElement("td");
              td.className = "numeric";
              td.textContent = formatRating(p[key]);
              tr.appendChild(td);
            }

            tbody.appendChild(tr);
          }

          table.appendChild(tbody);
          wrapper.appendChild(table);

          card.appendChild(header);
          card.appendChild(wrapper);

          dom.groupsContainer.appendChild(card);
        }
      }

      function handleTeamChange() {
        const key = dom.teamSelect.value;
        if (!key) {
          dom.clearTeamBtn.disabled = true;
          dom.groupsContainer.innerHTML = "";
          dom.teamMeta.style.display = "none";
          dom.summaryMain.textContent =
            "Select a team to view its full rating grid by position group.";
          return;
        }
        dom.clearTeamBtn.disabled = false;
        const team = gTeams.find((t) => t.key === key);
        if (!team) return;

        renderTeamMeta(team);
        renderGroupsForTeam(team);

        const name = team.teamName || team.teamId || "(Unnamed)";
        dom.summaryMain.textContent =
          "Showing full rating grid for " +
          name +
          " – " +
          team.players.length +
          " players.";
      }

      function handleClearTeam() {
        dom.teamSelect.value = "";
        handleTeamChange();
      }

      async function init() {
        setStatus("loading", "Loading team ratings…");
        hideError();
        dom.summarySource.textContent =
          "Source: " +
          (RAW_PLAYERS_PARAM ? "custom players=" + RAW_PLAYERS_PARAM : "layer3_rosters.csv");

        const baseForBack =
          "index.html" +
          (RAW_PLAYERS_PARAM
            ? "?players=" + encodeURIComponent(RAW_PLAYERS_PARAM)
            : "");
        dom.backLink.href = baseForBack;

        try {
          const t0 = performance.now();
          const text = await fetchCsvText(EFFECTIVE_CSV_URL);
          const t1 = performance.now();

          const rows = parseCsvToRows(text);
          const objs = rowsToObjectsWithDedupHeader(rows);
          gAllRows = objs;

          gAllRatingColumns = computeRatingColumns(objs);
          gTeams = buildTeamsFromRows(objs);

          renderTeamOptions(gTeams);

          const t2 = performance.now();
          const loadMs = Math.round(t1 - t0);
          const buildMs = Math.round(t2 - t1);

          dom.summaryMain.textContent =
            "Loaded " +
            gTeams.length +
            " teams and " +
            gAllRows.length +
            " player rows in " +
            loadMs +
            " ms (parse + " +
            buildMs +
            " ms group by team). Pick a team to inspect.";

          setStatus("ready", "Team ratings loaded");

          const initialKey = urlParams.get("team") || "";
          if (initialKey) {
            const team = gTeams.find(
              (t) =>
                t.teamId === initialKey ||
                t.key === initialKey ||
                t.teamName === initialKey
            );
            if (team) {
              dom.teamSelect.value = team.key;
              handleTeamChange();
            }
          }
        } catch (err) {
          console.error(err);
          showError(
            "Could not load or parse the roster CSV.",
            err && err.message ? err.message : String(err)
          );
        }
      }

      dom.teamSelect.addEventListener("change", handleTeamChange);
      dom.clearTeamBtn.addEventListener("click", handleClearTeam);

      init();
    })();
  </script>
</body>
</html>

<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFL Sim - Weekly Games</title>
<style>
:root{
  --bg:#0b1220; --panel:#121a2a; --card:#0e1630; --text:#eef2ff; --muted:#93a0b1;
  --accent:#5eead4; --home:#4ade80; --away:#60a5fa;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  display:grid;place-items:center
}
main{width:min(920px,92vw);display:grid;gap:16px}
h1{margin:0 0 6px;font-size:22px;letter-spacing:.2px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
.card{
  display:block;background:var(--panel);border-radius:14px;padding:14px;text-decoration:none;color:inherit;
  border:1px solid #1c2440;box-shadow:0 6px 24px rgba(0,0,0,.25);
  transition:border-color .15s ease, transform .08s ease, box-shadow .15s ease;
}
.card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,.35)}
.cardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.title{font-weight:800;font-size:16px}
.meta{font-size:12px;color:var(--muted)}
.badges{display:flex;gap:8px;align-items:center}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--card);border:1px solid #233055;font-size:12px;color:var(--muted)}
.pill.home{color:var(--home)} .pill.away{color:var(--away)}
hr{height:1px;background:#1c2440;border:0;margin:10px 0;border-radius:2px}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:10px;background:var(--accent);color:#0a0f17;font-weight:700;font-size:14px;border:none;box-shadow:0 2px 0 rgba(0,0,0,.25);text-decoration:none}
.card:hover .btn{box-shadow:0 3px 0 rgba(0,0,0,.28)}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <main>
    <div class="row">
      <h1 id="page-title">Loading Week 1 Games...</h1>
      <div class="nav">
        <a id="toSchedule" class="btn">Schedule</a>
        <a id="toSimulation" class="btn" style="text-decoration:none;background:#0e1630;color:#dbe3ef;border:1px solid #2a355a">
          Simulation
        </a>
        <a id="toStandings" class="btn" style="text-decoration:none;background:#0e1630;color:#dbe3ef;border:1px solid #2a355a">
          Standings
        </a>
      </div>
    </div>
    <div class="grid" id="game-grid"></div>
    <div class="small">Tip: Click any card to open the simulator with these teams preloaded.</div>
  </main>

<script>
// Params (so we can preserve players/schedule across pages)
const PARAMS = new URLSearchParams(location.search);
const RAW_PLAYERS_PARAM = (PARAMS.get('players') || '').replace('/refs/heads/', '/');
const RAW_SCHEDULE_PARAM = (PARAMS.get('schedule') || '').replace('/refs/heads/', '/');

// Build param string to forward
const playersParamStr = RAW_PLAYERS_PARAM ? `players=${encodeURIComponent(RAW_PLAYERS_PARAM)}` : '';
const schedParamStr   = RAW_SCHEDULE_PARAM ? `schedule=${encodeURIComponent(RAW_SCHEDULE_PARAM)}` : '';
const join = (...parts)=> parts.filter(Boolean).join('&');
const forwardQS = join(playersParamStr, schedParamStr);
const qs = forwardQS ? `?${forwardQS}` : '';

// Wire nav
document.getElementById('toSchedule').href   = `schedule.html${qs}`;
document.getElementById('toSimulation').href = `simulation.html${qs}`;
document.getElementById('toStandings').href  =
  `standings.html${playersParamStr ? `?${playersParamStr}` : ''}`;

// Players CSV resolution (same-origin first, then raw GH, unless ?players= provided)
const CSV_URLS = RAW_PLAYERS_PARAM
  ? [RAW_PLAYERS_PARAM, new URL('players.csv', location.href).href]
  : [new URL('players.csv', location.href).href,
     'https://raw.githubusercontent.com/aaronwolk00/game_sim/refs/heads/main/players.csv'];

async function fetchCsvText(){
  let lastErr = null;
  for (const url of CSV_URLS){
    try{
      const res = await fetch(url, { cache: 'no-store', mode: 'cors' });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const txt = await res.text();
      return { txt, url };
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('CSV not reachable');
}

function parseCsvToRows(text){
  text = String(text||'').replace(/^\uFEFF/,'');
  const rows=[]; let row=[], field='', q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(q){
      if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else q=false; }
      else field+=c;
    }else{
      if(c==='"') q=true;
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
      else if(c!=='\r'){ field+=c; }
    }
  }
  row.push(field); rows.push(row);
  return rows.filter(r=>r.length && r.some(x=>x!==''));
}
function findHeaderIndex(rows){
  const norm=s=>String(s||'').trim().toLowerCase();
  for(let i=0;i<Math.min(rows.length,8);i++){
    if(rows[i].some(c=>norm(c)==='team')) return i;
  }
  return -1;
}
function rowsToObjects(rows, headerIdx){
  const header = rows[headerIdx].map(h => String(h||'').trim());
  return rows.slice(headerIdx+1).map(r=>{
    const o={}; header.forEach((h,j)=> o[h]= r[j]===undefined ? '' : r[j]); return o;
  });
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

async function loadGames(){
  const grid = document.getElementById('game-grid');
  const title = document.getElementById('page-title');

  try{
    const { txt: text, url: csvUrlUsed } = await fetchCsvText();

    const rows = parseCsvToRows(text);
    const headerIdx = findHeaderIndex(rows);
    if (headerIdx < 0) throw new Error('No "Team" header row found');

    const objs = rowsToObjects(rows, headerIdx);
    const teams = Array.from(new Set(
      objs.map(r => String(r.Team||'').trim()).filter(Boolean)
    ));

    shuffle(teams);

    const playersParam = encodeURIComponent(csvUrlUsed);
    let html = '';
    for (let i=0; i+1<teams.length; i+=2){
      const home = teams[i], away = teams[i+1];
      const url = `game.html?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&players=${playersParam}`;
      html += `
        <a class="card" href="${url}" aria-label="${home} vs. ${away} â€” Play Sim">
          <div class="cardHeader">
            <div class="title">${home} vs. ${away}</div>
            <span class="btn" role="button">Play Sim</span>
          </div>
          <hr>
          <div class="badges">
            <span class="pill home">${home}</span>
            <span class="pill away">${away}</span>
          </div>
        </a>`;
    }

    grid.innerHTML = html || '<div class="small" style="color:#fca5a5">No pairable teams found.</div>';
    title.textContent = 'Week 1 Games';

  }catch(err){
    console.error(err);
    title.textContent = 'Error loading games';
    document.getElementById('game-grid').innerHTML =
      `<p style="color:#fca5a5">Could not load teams from the CSV. Check the URL (must be a <em>raw</em> link) and that a header row contains a <code>Team</code> column.</p>`;
  }
}

document.addEventListener('DOMContentLoaded', loadGames);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DNA Football Simulation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #050815;
      --bg-alt: #0b1020;
      --panel-bg: #10152a;
      --panel-bg-alt: #131933;
      --accent: #3ea6ff;
      --accent-soft: rgba(62, 166, 255, 0.16);
      --accent-strong: rgba(62, 166, 255, 0.4);
      --text: #f5f7ff;
      --text-soft: #a9b3d9;
      --danger: #ff4b6a;
      --success: #3dd68c;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --radius-lg: 12px;
      --radius-md: 8px;
      --radius-sm: 4px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
      --shadow-sm: 0 6px 20px rgba(0, 0, 0, 0.45);
      --transition-fast: 140ms ease-out;
      --transition-med: 200ms ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      font-size: clamp(14px, 0.95vw, 17px);
      background: radial-gradient(circle at top, #121b3b 0, #050815 40%, #02010a 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      padding: 20px 2.2vw 28px;
      max-width: 1920px;
      width: min(98vw, 1920px);
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    header h1 {
      margin: 0;
      font-size: 1.9rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid var(--accent-soft);
      color: var(--accent);
      background: linear-gradient(
        90deg,
        rgba(62, 166, 255, 0.1),
        rgba(62, 166, 255, 0.02)
      );
    }

    header p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button,
    select {
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(10, 16, 35, 0.95);
      color: var(--text);
      padding: 8px 14px;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-fast),
        border-color var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary {
      background: linear-gradient(
        135deg,
        rgba(62, 166, 255, 0.1),
        rgba(62, 166, 255, 0.7)
      );
      border-color: var(--accent);
    }

    .btn-ghost {
      background: rgba(15, 20, 40, 0.9);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .btn:hover:not(:disabled) {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, var(--accent-soft), #0b1020);
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
    }

    .btn-icon {
      padding-inline: 8px;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.65fr) minmax(0, 1.05fr);
      gap: 18px;
      align-items: start;
    }
    @media (max-width: 1260px) {
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Right rail keeps context visible; tables are sized for a rail */
    #panel-right-rail { position: sticky; top: 12px; align-self: start; }

    #drive-summary-wrapper,
    #team-stats-wrapper { max-height: clamp(240px, 31vh, 480px); }

    #play-log-container,
    .log-container { max-height: clamp(520px, 68vh, 900px); }

    #panel-right-rail table { font-size: 0.78rem; }
    #panel-right-rail th, #panel-right-rail td { padding: 4px 8px; }

    /* Slightly larger scoreline still fits the wider middle column */
    .score-main .scoreline { font-size: 2.3rem; }

    /* (Already present) custom scrollbars apply to rail as well */


    .panel {
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.06), transparent 55%),
        linear-gradient(145deg, var(--panel-bg), var(--panel-bg-alt));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
      position: relative;
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 1.0rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-title span.label {
      font-weight: 600;
    }

    .panel-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      color: var(--text-soft);
    }

    .badge.badge-accent {
      border-color: var(--accent-soft);
      color: var(--accent);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(62, 166, 255, 0.25);
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .field-group label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    select,
    input[type="number"],
    input[type="text"] {
      background: rgba(5, 10, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: var(--radius-md);
      color: var(--text);
      padding: 6px 8px;
      font-size: 0.85rem;
      min-width: 140px;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        background var(--transition-fast);
    }

    select:focus,
    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: rgba(10, 15, 40, 0.98);
    }

    .radio-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }

    .radio-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      cursor: pointer;
      color: var(--text-soft);
      background: rgba(10, 14, 30, 0.9);
      transition: border-color var(--transition-fast),
        background var(--transition-fast),
        color var(--transition-fast);
    }

    .radio-pill input {
      accent-color: var(--accent);
    }

    .radio-pill.active {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, var(--accent-soft), #0b1020);
      color: var(--accent);
    }

    .scoreboard {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .team-card {
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.06), transparent 55%);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .team-card .team-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .team-card .team-name {
      font-size: 0.9rem;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .team-card .team-meta {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .score-main {
      text-align: center;
      padding: 6px 2px;
      border-radius: var(--radius-md);
      background: linear-gradient(
        135deg,
        rgba(62, 166, 255, 0.15),
        rgba(55, 125, 255, 0.5)
      );
      border: 1px solid var(--accent);
      box-shadow: 0 0 20px var(--accent-soft);
    }

    .score-main .scoreline {
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 0.16em;
    }

    .score-main .scoreline span {
      margin: 0 6px;
    }

    .score-main .score-meta {
      font-size: 0.9rem;
      color: #e3ecff;
      margin-top: 4px;
    }

    /* === Broadcast Scorebar ============================= */
    :root { --num-font: tabular-nums lining-nums; }
    .num { font-variant-numeric: var(--num-font); }

    .scorebar{
      position: relative;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      height: 52px;                 /* expanded height */
      padding: 0 12px;
      margin-bottom: 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background:
        linear-gradient(145deg, rgba(30,50,100,.35), rgba(15,20,40,.85)),
        linear-gradient(180deg, var(--panel-bg), var(--panel-bg-alt));
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      transition: height var(--transition-med), padding var(--transition-med);
    }

    .scorebar.is-collapsed{
      height: 36px;                 /* shuttered height */
      padding-top: 0; padding-bottom: 0;
    }

    /* shutter button (left edge) */
    .sb-shutter{
      position: absolute; left: 6px; top: 50%; transform: translateY(-50%);
      width: 18px; height: 18px; border-radius: 999px;
      border: 1px solid var(--border-subtle); background: rgba(255,255,255,.06);
      cursor: pointer;
    }
    .scorebar.is-collapsed .sb-shutter{ transform: translateY(-50%) rotate(180deg); }

    /* teams */
    .sb-team{
      display: flex; align-items: center; gap: 10px;
      font-weight: 650; letter-spacing: .03em;
    }
    .sb-home { justify-self: start; padding-left: 24px; }
    .sb-away { justify-self: end;  padding-right: 8px; }

    .sb-abbr{
      font-size: 0.95rem; text-transform: uppercase;
      color: #e7eeff; opacity: .95;
    }
    .sb-score{
      font-size: 1.45rem; font-weight: 800;
      text-shadow: 0 0 18px rgba(62,166,255,.28);
    }

    .sb-center{
      display: flex; align-items: baseline; gap: 8px;
      padding: 4px 10px; border-radius: 8px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
    }
    .sb-quarter{ font-size: .88rem; color: var(--text-soft); }
    .sb-clock{ font-size: 1.05rem; font-weight: 700; }

    /* possession dots */
    .sb-pos-dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: transparent; box-shadow: none; opacity: .85;
    }
    .scorebar.pos-home .sb-home .sb-pos-dot{ background: var(--accent); box-shadow: 0 0 0 4px var(--accent-soft); }
    .scorebar.pos-away .sb-away .sb-pos-dot{ background: var(--accent); box-shadow: 0 0 0 4px var(--accent-soft); }

    /* game progress */
    .sb-progress{
      position: absolute; left: 8px; right: 8px; bottom: 6px; height: 3px;
      border-radius: 999px; overflow: hidden; background: rgba(255,255,255,.08);
    }
    .sb-progress::before{
      content:""; display:block; height:100%; width: var(--_pct, 0%);
      background: linear-gradient(90deg, var(--accent), color-mix(in oklab, var(--accent) 50%, white));
      transition: width var(--transition-med);
    }

    /* compact tweaks when collapsed */
    .scorebar.is-collapsed .sb-abbr{ font-size:.82rem; }
    .scorebar.is-collapsed .sb-score{ font-size:1.2rem; }
    .scorebar.is-collapsed .sb-center{ padding:2px 8px; }


    .game-state-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 4px;
    }

    .state-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(8, 13, 32, 0.9);
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .state-pill strong {
      color: var(--text);
      font-weight: 600;
    }

    .subtle-label {
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .flex-spacer {
      flex: 1;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .horizontal-stack {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .section-divider {
      margin: 8px -14px 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
    }

    .table-wrapper {
      max-height: clamp(320px, 38vh, 640px); /* was 260px */
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.07);
      background: rgba(5, 8, 20, 0.9);
    }

    /* Player box score should be tall â€“ it's the most scroll-heavy */
    #player-stats-wrapper {
      max-height: clamp(420px, 48vh, 780px);
    }

    /* Drive summary & team stats: give them more breathing room */
    #drive-summary-wrapper,
    #team-stats-wrapper {
      max-height: clamp(320px, 34vh, 560px);
    }

    /* Play log: taller so you can read a lot at once */
    #play-log-container,
    .log-container {
      max-height: clamp(420px, 50vh, 820px); /* was 320px */
      font-size: 0.9rem;                     /* slightly larger log text */
      line-height: 1.35;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    /* tabular numerals improve readability in tables/logs */
    td, th, .log-text, .scorebar .num { font-variant-numeric: tabular-nums lining-nums; }
    th[data-align="r"], td[data-align="r"] { text-align: right; }

    th,
    td {
      padding: 4px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      white-space: nowrap;
    }

    th {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(5, 8, 20, 0.98), rgba(5, 8, 20, 0.94));
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.78rem;
      color: var(--text-soft);
      z-index: 2;
      backdrop-filter: blur(3px);
      box-shadow: 0 2px 0 rgba(255,255,255,0.04);
    }

    tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.01);
    }

    tbody tr:hover {
      background: rgba(62, 166, 255, 0.07);
    }

    /* Slightly larger rows for clickability */
    tbody tr td { padding: 6px 10px; }

    /* Make the D&D / state pills slightly larger */
    .state-pill { font-size: 0.85rem; padding: 5px 10px; }

    /* Buttons: a hair more presence */
    .btn-ghost { background: rgba(15, 20, 40, 0.95); }


    .log-container {
      max-height: 320px;
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(5, 8, 20, 0.9);
      padding: 6px 0;
      font-size: 0.82rem;
    }

    .log-entry {
      padding: 4px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      gap: 6px;
    }

    .log-entry .log-meta {
      min-width: 68px;
      color: var(--text-soft);
      font-size: 0.75rem;
    }

    .log-entry .log-text {
      flex: 1;
    }

    .log-entry.key-play {
      background: rgba(62, 166, 255, 0.08);
    }

    .log-entry.scoring {
      border-left: 2px solid var(--accent);
    }

    .log-entry.turnover {
      border-left: 2px solid var(--danger);
    }

    .tag {
      font-size: 0.72rem;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--text-soft);
    }

    .tag.tag-off {
      border-color: rgba(62, 166, 255, 0.45);
      color: var(--accent);
    }

    .tag.tag-def {
      border-color: rgba(150, 255, 210, 0.4);
      color: var(--success);
    }

    .tag.tag-st {
      border-color: rgba(255, 220, 150, 0.4);
      color: #ffd98d;
    }

    details.debug-panel {
      margin-top: 12px;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(255, 255, 255, 0.25);
      background: rgba(6, 9, 20, 0.9);
    }

    details.debug-panel[open] {
      background: rgba(10, 14, 30, 0.96);
    }

    details.debug-panel > summary {
      list-style: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-soft);
    }

    details.debug-panel > summary::marker {
      display: none;
    }

    details.debug-panel > summary::-webkit-details-marker {
      display: none;
    }

    .debug-body {
      padding: 6px 10px 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .chip {
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(7, 11, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 0.74rem;
      color: var(--text-soft);
    }

    .pill-status {
      font-size: 0.76rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-status .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(61, 214, 140, 0.25);
    }

    .pill-status.pending .dot {
      background: #f8b84a;
      box-shadow: 0 0 0 3px rgba(248, 184, 74, 0.25);
    }

    .pill-status.error .dot {
      background: var(--danger);
      box-shadow: 0 0 0 3px rgba(255, 75, 106, 0.25);
    }

    .text-muted {
      color: var(--text-soft);
    }

    footer {
      margin-top: auto;
      padding: 8px 5vw 12px;
      font-size: 0.74rem;
      color: var(--text-soft);
      opacity: 0.7;
      text-align: right;
    }

    /* ===== Modern, consistent scrollbars for tables & logs ===== */
    .table-wrapper,
    .log-container {
      scrollbar-width: thin;  /* Firefox */
      scrollbar-color: rgba(62,166,255,0.45) rgba(255,255,255,0.06);
    }

    .table-wrapper::-webkit-scrollbar,
    .log-container::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    .table-wrapper::-webkit-scrollbar-track,
    .log-container::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
    }

    .table-wrapper::-webkit-scrollbar-thumb,
    .log-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(62,166,255,0.65), rgba(62,166,255,0.35));
      border: 2px solid rgba(5,8,20,0.95);
      border-radius: 10px;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover,
    .log-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, rgba(62,166,255,0.85), rgba(62,166,255,0.55));
    }

  </style>
</head>
<body>
  <main>
    <header>
      <div class="title-block">
        <h1>
          Football Engine
          <span class="pill">Single Game Simulation</span>
        </h1>
      </div>
      <div class="header-actions">
        <span id="sim-engine-status" class="pill-status pending">
          <span class="dot"></span>
          <span>Engine not initialized</span>
        </span>
        <button id="btn-random-matchup" class="btn btn-ghost" type="button">
          ðŸŽ² Random Matchup
        </button>
        <button id="btn-run-sim" class="btn btn-primary" type="button" disabled>
          â–¶ Run Simulation
        </button>
      </div>
    </header>

    <section class="layout-grid" aria-label="Simulation controls and game summary">

      <!-- LEFT COLUMN: Controls + scoreboard + game state -->
      <section class="panel" id="panel-controls">
        <div class="panel-header">
          <div class="panel-title">
            <span class="label">Matchup & Controls</span>
          </div>
          <div class="panel-header-right">
            <span class="badge badge-accent">Teams</span>
          </div>
        </div>

        <div class="control-row">
          <div class="field-group" style="flex: 1 1 160px;">
            <label for="select-home-team">Home Team</label>
            <select id="select-home-team"></select>
          </div>
          <div class="field-group" style="flex: 1 1 160px;">
            <label for="select-away-team">Away Team</label>
            <select id="select-away-team"></select>
          </div>
          <div class="field-group" style="flex: 0 0 60px;">
            <label for="input-seed">Seed</label>
            <input
              id="input-seed"
              type="number"
              value=""
              placeholder="Auto"
              min="1"
              step="1"
            />
          </div>
        </div>

        <!-- Scoreboard (broadcast strip, shuttered) -->
        <div class="scorebar" id="scorebar" aria-label="Scoreboard">
          <button class="sb-shutter" id="scorebar-toggle" aria-label="Collapse scoreboard"></button>

          <div class="sb-team sb-home">
            <span class="sb-abbr" id="home-team-abbr">HOME</span>
            <span class="sb-score num" id="score-home">0</span>
            <span class="sb-pos-dot" aria-hidden="true"></span>
          </div>

          <div class="sb-center">
            <span class="sb-quarter" id="score-quarter">Q1</span>
            <span class="sb-clock num" id="score-clock">15:00</span>
          </div>

          <div class="sb-team sb-away">
            <span class="sb-pos-dot" aria-hidden="true"></span>
            <span class="sb-score num" id="score-away">0</span>
            <span class="sb-abbr" id="away-team-abbr">AWAY</span>
          </div>

          <div class="sb-progress" id="score-progress"></div>
        </div>


        <div class="control-row">
          <div class="field-group" style="flex: 1 1 220px;">
            <label>Simulation Mode</label>
            <div id="sim-mode-group" class="radio-group">
              <label class="radio-pill active">
                <input type="radio" name="sim-mode" value="full-game" checked />
                Full Game
              </label>
              <label class="radio-pill">
                <input type="radio" name="sim-mode" value="drive-step" />
                Drive-by-drive
              </label>
              <label class="radio-pill">
                <input type="radio" name="sim-mode" value="play-step" />
                Play-by-play
              </label>
            </div>
          </div>
        </div>

        <div class="control-row">
          <button id="btn-step-drive" class="btn btn-ghost" type="button" disabled>
            âž¤ Next Drive
          </button>
          <button id="btn-step-play" class="btn btn-ghost" type="button" disabled>
            â–¶ Next Play
          </button>
          <button id="btn-reset" class="btn btn-ghost" type="button" disabled>
            âŸ² Reset
          </button>
          <span class="flex-spacer"></span>
          <span class="subtle-label" id="sim-status-text">
            Load teams to begin.
          </span>
        </div>

        <div class="section-divider"></div>

        <!-- Player Box Score -->
        <div class="field-group">
          <label>Player Box Score</label>
          <div class="table-wrapper" id="player-stats-wrapper">
            <table id="player-stats-table">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Team</th>
                  <th>Pos</th>
                  <th>C/Att</th>
                  <th>PYds</th>
                  <th>PTD</th>
                  <th>INT</th>
                  <th>RAtt</th>
                  <th>RYds</th>
                  <th>RTD</th>
                  <th>Tgt</th>
                  <th>Rec</th>
                  <th>RecYds</th>
                  <th>RecTD</th>
                  <th>FG</th>
                  <th>XP</th>
                  <th>Punts</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Game state summary: down & distance, field pos, timeouts, momentum -->
        <div class="stack">
          <div class="game-state-row">
            <div class="state-pill" id="state-down-distance">
              <strong>Down &amp; Distance:</strong> â€“
            </div>
            <div class="state-pill" id="state-field-pos">
              <strong>Field:</strong> â€“
            </div>
            <div class="state-pill" id="state-possession">
              <strong>Ball:</strong> â€“
            </div>
          </div>

          <div class="game-state-row">
            <div class="state-pill" id="state-timeouts">
              <strong>Timeouts:</strong>
              <span>Home 3</span> | <span>Away 3</span>
            </div>
            <div class="state-pill" id="state-momentum">
              <strong>Momentum:</strong> Neutral
            </div>
          </div>
        </div>

        <details class="debug-panel" id="debug-meta-panel">
          <summary>
            <span>Diagnostics</span>
            <span class="badge">Engine</span>
          </summary>
          <div class="debug-body" id="debug-meta-body">
            <div class="chip-row">
              <span class="chip" id="chip-layer-meta">Layers: 0 â†’ 1 â†’ 2 â†’ 3 â†’ Sim</span>
              <span class="chip" id="chip-sim-mode-meta">Mode: Full Game</span>
            </div>
            <div class="stack">
              <span class="text-muted" id="debug-engine-line">
                Engine logs and sanity checks will appear here.
              </span>
            </div>
          </div>
        </details>
      </section>

      <!-- MIDDLE COLUMN: Play-by-Play only -->
      <section class="panel" id="panel-analytics">
        <div class="panel-header">
          <div class="panel-title">
            <span class="label">Play-by-Play</span>
          </div>
          <div class="panel-header-right">
            <span class="badge">Live</span>
          </div>
        </div>

        <div class="stack">
          <div class="field-group">
            <label>Play Log</label>
            <div class="log-container" id="play-log-container" aria-live="polite">
              <div class="log-entry">
                <div class="log-meta">Pre-game</div>
                <div class="log-text text-muted">
                  Select teams and run a simulation to see detailed play-by-play output here.
                </div>
              </div>
            </div>
          </div>

          <details class="debug-panel" id="debug-micro-panel">
            <summary>
              <span>Advanced Micro-Model Diagnostics</span>
              <span class="badge badge-accent">Optional</span>
            </summary>
            <div class="debug-body">
              <div class="chip-row">
                <span class="chip">Pass rush vs OL: TTP distribution</span>
                <span class="chip">WR/DB: separation &amp; contest</span>
                <span class="chip">YAC &amp; tackling mismatch</span>
                <span class="chip">Penalty &amp; chaos events</span>
              </div>
              <p class="text-muted" id="debug-micro-text">
                The JS engine can emit summary statistics for key micro-models
                (time to pressure, separation, ball placement error, run-fit outcomes, etc.).
                Those summaries can be rendered here without changing the core simulation logic.
              </p>
            </div>
          </details>
        </div>
      </section>

      <!-- RIGHT COLUMN: Drive Summary + Team Stats (sticky rail) -->
      <section class="panel" id="panel-right-rail">
        <div class="panel-header">
          <div class="panel-title">
            <span class="label">Game Flow & Team Stats</span>
          </div>
          <div class="panel-header-right">
            <span class="badge">Summary</span>
          </div>
        </div>

        <div class="stack">
          <div class="horizontal-stack" style="align-items: stretch;">
            <div class="field-group" style="flex: 1 1 220px;">
              <label>Drive Summary</label>
              <div class="table-wrapper" id="drive-summary-wrapper">
                <table id="drive-summary-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Team</th>
                      <th>Result</th>
                      <th>Plays</th>
                      <th>Yards</th>
                      <th>Time</th>
                    </tr>
                  </thead>
                  <tbody><!-- JS populates --></tbody>
                </table>
              </div>
            </div>

            <div class="field-group" style="flex: 1 1 220px;">
              <label>Team Stats (Live)</label>
              <div class="table-wrapper" id="team-stats-wrapper">
                <table id="team-stats-table">
                  <thead>
                    <tr>
                      <th>Team</th>
                      <th>Yards</th>
                      <th>Y/P</th>
                      <th>Rush</th>
                      <th>Pass</th>
                      <th>TO</th>
                      <th>EPA*</th>
                    </tr>
                  </thead>
                  <tbody><!-- JS populates --></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

    </section>
  </main>

  <footer>
    Simulation shell only. Core logic is implemented in ES modules
    (<code>config.js</code>, <code>data_models.js</code>,
    <code>random_models.js</code>, <code>micro_engine.js</code>,
    <code>game_engine.js</code>).
  </footer>


  <!-- Top-level module: imports other modules and wires up the UI. -->
  <script type="module">
    import { loadLeague } from './data_models.js';
    import { simulateGame } from './game_engine.js';

    // --- Resolve CSV + optional home/away from URL params -----------------------
    const PARAMS = new URLSearchParams(location.search);

    // Allow ?players=<url> override. If not present, use your Layer 3 roster.
    const RAW_PLAYERS_PARAM = (PARAMS.get('players') || '').replace('/refs/heads/', '/');
    const DEFAULT_CSV_URL =
    'https://raw.githubusercontent.com/aaronwolk00/game_sim/refs/heads/main/layer3_rosters.csv';

    const CSV_URL = RAW_PLAYERS_PARAM || DEFAULT_CSV_URL;

    // Optional: pre-select teams if ?home= / ?away= are passed in.
    const HOME_PARAM = PARAMS.get('home') || '';
    const AWAY_PARAM = PARAMS.get('away') || '';


    // ----- DOM LOOKUPS -------------------------------------------------------
    const dom = {
      engineStatus: document.getElementById('sim-engine-status'),
      statusText: document.getElementById('sim-status-text'),
      btnRandom: document.getElementById('btn-random-matchup'),
      btnRun: document.getElementById('btn-run-sim'),
      btnStepDrive: document.getElementById('btn-step-drive'),
      btnStepPlay: document.getElementById('btn-step-play'),
      btnReset: document.getElementById('btn-reset'),
      scoreQuarter: document.getElementById('score-quarter'),
      scoreClock: document.getElementById('score-clock'),
      homeAbbr: document.getElementById('home-team-abbr'),
      awayAbbr: document.getElementById('away-team-abbr'),
      scoreProgress: document.getElementById('score-progress'),
      scorebar: document.getElementById('scorebar'),
      scorebarToggle: document.getElementById('scorebar-toggle'),

      selectHome: document.getElementById('select-home-team'),
      selectAway: document.getElementById('select-away-team'),
      inputSeed: document.getElementById('input-seed'),

      simModeGroup: document.getElementById('sim-mode-group'),

      homeName: document.getElementById('home-team-name'),
      homeMeta: document.getElementById('home-team-meta'),
      awayName: document.getElementById('away-team-name'),
      awayMeta: document.getElementById('away-team-meta'),
      scoreHome: document.getElementById('score-home'),
      scoreAway: document.getElementById('score-away'),
      scoreMeta: document.getElementById('score-meta'),

      stateDownDist: document.getElementById('state-down-distance'),
      stateFieldPos: document.getElementById('state-field-pos'),
      statePossession: document.getElementById('state-possession'),
      stateTimeouts: document.getElementById('state-timeouts'),
      stateMomentum: document.getElementById('state-momentum'),

      chipSimMode: document.getElementById('chip-sim-mode-meta'),
      debugEngineLine: document.getElementById('debug-engine-line'),
      debugMicroText: document.getElementById('debug-micro-text'),

      driveTableBody: document.querySelector('#drive-summary-table tbody'),
      teamStatsBody: document.querySelector('#team-stats-table tbody'),
      playLog: document.getElementById('play-log-container'),
      playerStatsBody: document.querySelector('#player-stats-table tbody'),
    };

    // ----- STATE -------------------------------------------------------------
    let league = null;
    let currentHomeTeam = null;
    let currentAwayTeam = null;

    let currentResult = null;   // last simulateGame(...) result
    let simMode = 'full-game';  // 'full-game' | 'drive-step' | 'play-step'

    // For incremental reveal (UI stepping only â€“ underlying sim is full-game).
    let stepState = {
      driveIndex: -1,
      playIndex: -1,
    };

    // ----- SMALL HELPERS -----------------------------------------------------
      // Quick CSV probe: fetch raw text, count rows/cols, show a few team ids.
    async function probeCSV(url) {
        try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const lines = text.trim().split(/\r?\n/);
        const header = lines[0] || '';
        const cols = header.split(',');
        const rowCount = Math.max(0, lines.length - 1);

        // Find indices so we donâ€™t assume column order.
        const idxTeam = cols.indexOf('team_id');
        const idxName = cols.indexOf('team_name');

        // Collect a few unique teams to display.
        const seen = new Set();
        const sample = [];
        for (let i = 1; i < Math.min(lines.length, 200); i++) {
            const cells = lines[i].split(',');
            const id = cells[idxTeam] || '';
            const name = cells[idxName] || '';
            if (id && !seen.has(id)) {
            sample.push(name ? `${id} (${name})` : id);
            seen.add(id);
            if (sample.length >= 6) break;
            }
        }

        const msg = `CSV OK: ${rowCount.toLocaleString()} rows â€¢ ${cols.length} cols â€¢ sample teams: ${sample.join(', ')}`;
        const div = document.createElement('div');
        div.className = 'text-muted';
        div.textContent = msg;
        document.getElementById('debug-meta-body')?.appendChild(div);
        } catch (e) {
        const div = document.createElement('div');
        div.className = 'text-muted';
        div.textContent = `CSV load failed: ${e.message}`;
        document.getElementById('debug-meta-body')?.appendChild(div);
        }
    }


    function setEngineStatus(state, message) {
      // state: 'pending' | 'ready' | 'error'
      const pill = dom.engineStatus;
      if (!pill) return;

      pill.classList.remove('pending', 'error');
      const dot = pill.querySelector('.dot');
      const textSpan = pill.querySelector('span:nth-child(2)');

      if (state === 'pending') {
        pill.classList.add('pending');
        if (dot) dot.style.background = '#f8b84a';
        if (textSpan) textSpan.textContent = message ?? 'Loading engineâ€¦';
      } else if (state === 'error') {
        pill.classList.add('error');
        if (dot) dot.style.background = 'var(--danger)';
        if (textSpan) textSpan.textContent = message ?? 'Engine error';
      } else {
        // ready
        if (dot) dot.style.background = 'var(--success)';
        if (textSpan) textSpan.textContent = message ?? 'Engine ready';
      }
    }

    function setSimStatus(text) {
      if (dom.statusText) dom.statusText.textContent = text;
    }

    function safeNumber(v, fallback = 0) {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    function formatClockFromSeconds(seconds) {
      if (!Number.isFinite(seconds)) return '0:00';
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60)
        .toString()
        .padStart(2, '0');
      return `${m}:${s}`;
    }

    function clearElement(el) {
      if (el) el.innerHTML = '';
    }

    function getTeamLabel(team) {
      if (!team) return 'Unknown';
      return (
        team.displayName ||
        team.team_name ||
        team.teamName ||
        `${team.teamId ?? team.id ?? '??'}`
      );
    }

    function getTeamMetaString(team) {
      if (!team) return 'Ovr â€“ | Off â€“ | Def â€“ | ST â€“';
      const ratings =
        team.teamRatings ||
        team.ratings ||
        team.summary ||
        {};

      const ovr =
        ratings.overall ??
        ratings.ovr ??
        team.overall ??
        team.rating_overall ??
        'â€“';
      const off = ratings.offense ?? ratings.off ?? ratings.offenseOverall ?? 'â€“';
      const def = ratings.defense ?? ratings.def ?? ratings.defenseOverall ?? 'â€“';
      const st = ratings.specialTeams ?? ratings.st ?? ratings.stOverall ?? 'â€“';

      return `Ovr ${ovr} | Off ${off} | Def ${def} | ST ${st}`;
    }

    function getTeamAbbr(team){
      if(!team) return '---';
      return team.abbr || (team.team_name || team.teamName || '').split(' ').pop()?.slice(0,3).toUpperCase() || '---';
    }

    function computeGamePct(quarter, clock){
      // 15 min quarters, ignore OT nuance here
      const q = Number(quarter) && Number(quarter) <= 4 ? Number(quarter) : 4;
      const [mm, ss] = String(clock || '0:00').split(':').map(n => Number(n)||0);
      const secondsIntoGame = (q-1)*900 + (900 - (mm*60+ss));
      const pct = Math.max(0, Math.min(100, (secondsIntoGame/(4*900))*100));
      return pct;
    }

    function updateScorebarPossession(result){
      const t = result?.possessionTeamId || result?.possession || result?.meta?.possessionTeamId;
      dom.scorebar?.classList.remove('pos-home','pos-away');
      if(!t) return;
      const homeId = currentHomeTeam?.teamId || currentHomeTeam?.id;
      const awayId = currentAwayTeam?.teamId || currentAwayTeam?.id;
      if(t === homeId || t === 'home') dom.scorebar?.classList.add('pos-home');
      if(t === awayId || t === 'away') dom.scorebar?.classList.add('pos-away');
    }


    function getDrivesFromResult(result) {
      if (!result) return [];
      if (Array.isArray(result.driveSummaries)) return result.driveSummaries;
      if (Array.isArray(result.drives)) return result.drives;
      return [];
    }

    function getPlayLogFromResult(result) {
      if (!result) return [];
      if (Array.isArray(result.playLog)) return result.playLog;
      if (Array.isArray(result.plays)) return result.plays;
      return [];
    }

    function getTeamStatsFromResult(result, homeId, awayId) {
      const out = { home: {}, away: {} };
      if (!result) return out;

      const stats = result.teamStats || result.stats || {};
      if (stats.home || stats.away) {
        out.home = stats.home || {};
        out.away = stats.away || {};
      } else if (homeId && awayId) {
        out.home = stats[homeId] || {};
        out.away = stats[awayId] || {};
      }
      return out;
    }

    function getScoreFromResult(result) {
      if (!result) return { home: 0, away: 0 };

      const s = result.score || result.finalScore || {};
      const meta = result.meta || {};
      const endState = result.gameStateEnd || {};

      const home =
        s.home ??
        s.homeScore ??
        result.homeScore ??
        result.scoreHome ??
        0;
      const away =
        s.away ??
        s.awayScore ??
        result.awayScore ??
        result.scoreAway ??
        0;

      const quarter =
        endState.quarter ??
        endState.qtr ??
        meta.quarter ??
        meta.qtr ??
        4;
      const clock =
        endState.clock ??
        endState.gameClock ??
        meta.clock ??
        '0:00';

      return { home, away, quarter, clock };
    }

    // ----- UI WIRING ---------------------------------------------------------
    function wireSimModeRadios() {
      if (!dom.simModeGroup) return;

      const updateActive = () => {
        const inputs = dom.simModeGroup.querySelectorAll('input[name="sim-mode"]');
        inputs.forEach((input) => {
          const label = input.closest('.radio-pill');
          if (!label) return;
          if (input.checked) {
            label.classList.add('active');
            simMode = input.value;
          } else {
            label.classList.remove('active');
          }
        });

        if (dom.chipSimMode) {
          const label =
            simMode === 'full-game'
              ? 'Mode: Full Game'
              : simMode === 'drive-step'
              ? 'Mode: Drive-by-drive'
              : 'Mode: Play-by-play';
          dom.chipSimMode.textContent = label;
        }
      };

      dom.simModeGroup.addEventListener('change', (e) => {
        if (e.target && e.target.name === 'sim-mode') {
          updateActive();
          setSimStatus(
            simMode === 'full-game'
              ? 'Full game: one-click simulation.'
              : simMode === 'drive-step'
              ? 'Drive-by-drive: run once, then step through drives.'
              : 'Play-by-play: run once, then step through plays.'
          );
        }
      });

      updateActive();
    }

    function wireControls() {
      dom.btnRandom.addEventListener('click', () => {
        if (!league || !Array.isArray(league.teams) || league.teams.length < 2) {
          return;
        }
        const teams = league.teams;
        const idx1 = Math.floor(Math.random() * teams.length);
        let idx2 = Math.floor(Math.random() * teams.length);
        if (idx2 === idx1) {
          idx2 = (idx1 + 1) % teams.length;
        }
        dom.selectHome.value = teams[idx1].teamId || teams[idx1].id;
        dom.selectAway.value = teams[idx2].teamId || teams[idx2].id;
        syncSelectedTeamsToCards();
      });

      dom.selectHome.addEventListener('change', syncSelectedTeamsToCards);
      dom.selectAway.addEventListener('change', syncSelectedTeamsToCards);

      dom.btnRun.addEventListener('click', onRunSimulation);
      dom.btnStepDrive.addEventListener('click', onStepDrive);
      dom.btnStepPlay.addEventListener('click', onStepPlay);
      dom.btnReset.addEventListener('click', resetForNewSimulation);
      if (dom.scorebarToggle && dom.scorebar){
        dom.scorebarToggle.addEventListener('click', () => {
          dom.scorebar.classList.toggle('is-collapsed');
        });
      }
    }

    function enableControlsAfterLeagueLoad() {
      dom.btnRandom.disabled = false;
      dom.btnRun.disabled = false;
      dom.btnReset.disabled = false;
      dom.selectHome.disabled = false;
      dom.selectAway.disabled = false;
    }

    function disableStepButtons() {
      dom.btnStepDrive.disabled = true;
      dom.btnStepPlay.disabled = true;
    }

    function syncSelectedTeamsToCards() {
      if (!league || !Array.isArray(league.teams)) return;

      const findById = (id) =>
        league.teams.find((t) => t.teamId === id || t.id === id || t.abbr === id);

      currentHomeTeam = findById(dom.selectHome.value);
      currentAwayTeam = findById(dom.selectAway.value);

      // Old panel cards (if still in DOM)
      if (dom.homeName) dom.homeName.textContent = getTeamLabel(currentHomeTeam);
      if (dom.awayName) dom.awayName.textContent = getTeamLabel(currentAwayTeam);
      if (dom.homeMeta) dom.homeMeta.textContent = getTeamMetaString(currentHomeTeam);
      if (dom.awayMeta) dom.awayMeta.textContent = getTeamMetaString(currentAwayTeam);

      // New broadcast scorebar (if present)
      if (dom.homeAbbr) dom.homeAbbr.textContent = getTeamAbbr(currentHomeTeam);
      if (dom.awayAbbr) dom.awayAbbr.textContent = getTeamAbbr(currentAwayTeam);
    }


    // ----- RENDERING ---------------------------------------------------------
    function resetScoreboardOnly() {
      // numeric scores (common to both versions)
      if (dom.scoreHome) dom.scoreHome.textContent = '0';
      if (dom.scoreAway) dom.scoreAway.textContent = '0';

      // NEW broadcast scorebar fields, if present
      const hasScorebar = dom.scoreQuarter || dom.scoreClock || dom.scoreProgress;
      if (hasScorebar) {
        if (dom.scoreQuarter) dom.scoreQuarter.textContent = 'Q1';
        if (dom.scoreClock)   dom.scoreClock.textContent   = '15:00';
        if (dom.scoreProgress) dom.scoreProgress.style.setProperty('--_pct', '0%');
        if (dom.scorebar) dom.scorebar.classList.remove('pos-home', 'pos-away');
      }

      // OLD center meta (fallback if that DOM still exists)
      if (!hasScorebar && dom.scoreMeta) {
        dom.scoreMeta.textContent = 'Q1 â€¢ 15:00 â€¢ 0â€“0';
      }

      // game state chips
      if (dom.stateDownDist) dom.stateDownDist.innerHTML = '<strong>Down &amp; Distance:</strong> â€“';
      if (dom.stateFieldPos) dom.stateFieldPos.innerHTML = '<strong>Field:</strong> â€“';
      if (dom.statePossession) dom.statePossession.innerHTML = '<strong>Ball:</strong> â€“';
      if (dom.stateTimeouts) dom.stateTimeouts.innerHTML =
        '<strong>Timeouts:</strong> <span>Home 3</span> | <span>Away 3</span>';
      if (dom.stateMomentum) dom.stateMomentum.innerHTML = '<strong>Momentum:</strong> Neutral';
    }



    function resetTablesAndLogs() {
      clearElement(dom.driveTableBody);
      clearElement(dom.teamStatsBody);
      clearElement(dom.playLog);
      clearElement(dom.playerStatsBody);

      // placeholder log
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.innerHTML = `
        <div class="log-meta">Pre-game</div>
        <div class="log-text text-muted">
          Select teams and run a simulation to see detailed play-by-play output here.
        </div>`;
      dom.playLog.appendChild(div);
    }

    function resetForNewSimulation() {
      currentResult = null;
      stepState = { driveIndex: -1, playIndex: -1 };
      resetScoreboardOnly();
      resetTablesAndLogs();
      disableStepButtons();
      setSimStatus('Ready. Configure teams and run a simulation.');
      if (dom.debugEngineLine) {
        dom.debugEngineLine.textContent =
          'Engine logs and sanity checks will appear here.';
      }
    }

    function renderScoreboardFromResult(result) {
      const { home, away, quarter, clock } = getScoreFromResult(result);

      if (dom.scoreHome) dom.scoreHome.textContent = String(home);
      if (dom.scoreAway) dom.scoreAway.textContent = String(away);

      const qLabel = (quarter && quarter !== 'Final') ? `Q${quarter}` : 'Final';
      const clockLabel = clock || '0:00';

      // New strip
      if (dom.scoreQuarter) dom.scoreQuarter.textContent = qLabel;
      if (dom.scoreClock)   dom.scoreClock.textContent   = clockLabel;

      // simple progress estimate (0â€“100%) if you donâ€™t track exact elapsed
      if (dom.scoreProgress) {
        const pct = (quarter && quarter !== 'Final') ? ((quarter-1) / 4) * 100 : 100;
        dom.scoreProgress.style.setProperty('--_pct', `${Math.max(0, Math.min(100, pct))}%`);
      }

      // Old center line fallback
      if (!dom.scoreQuarter && dom.scoreMeta) {
        dom.scoreMeta.textContent = `${qLabel} â€¢ ${clockLabel} â€¢ ${away}â€“${home}`;
      }
    }



    function renderDriveSummary(result, maxDriveIndex = Infinity) {
      clearElement(dom.driveTableBody);
      const drives = getDrivesFromResult(result);
      if (!drives.length) return;

      drives.forEach((d, idx) => {
        if (idx > maxDriveIndex) return;
        const tr = document.createElement('tr');

        const teamId =
          d.teamId || d.offenseTeamId || d.team || d.offense || '';
        const teamLabel =
          teamId === (currentHomeTeam?.teamId || currentHomeTeam?.id)
            ? getTeamLabel(currentHomeTeam)
            : teamId === (currentAwayTeam?.teamId || currentAwayTeam?.id)
            ? getTeamLabel(currentAwayTeam)
            : teamId || '';

        const resultText = d.result || d.resultType || d.outcome || '';
        const plays = d.playCount ?? d.plays ?? d.numPlays ?? '';
        const yards =
          d.yards ??
          d.totalYards ??
          d.netYards ??
          '';
        const time =
          d.timeStr ??
          d.clock ??
          (Number.isFinite(d.durationSec)
            ? formatClockFromSeconds(d.durationSec)
            : '');

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${teamLabel}</td>
          <td>${resultText}</td>
          <td>${plays}</td>
          <td>${yards}</td>
          <td>${time}</td>
        `;
        dom.driveTableBody.appendChild(tr);
      });
    }

    function renderTeamStats(result) {
      clearElement(dom.teamStatsBody);
      if (!currentHomeTeam || !currentAwayTeam) return;

      const homeId = currentHomeTeam.teamId || currentHomeTeam.id;
      const awayId = currentAwayTeam.teamId || currentAwayTeam.id;

      const { home, away } = getTeamStatsFromResult(result, homeId, awayId);

      const addRow = (label, s) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${label}</td>
          <td>${s.yardsTotal ?? s.totalYards ?? s.yards ?? 0}</td>
          <td>${(s.yardsPerPlay ?? s.ypp ?? 0).toFixed
            ? (s.yardsPerPlay ?? s.ypp ?? 0).toFixed(2)
            : s.yardsPerPlay ?? s.ypp ?? 0}</td>
          <td>${s.rushYards ?? s.rushingYards ?? s.rush ?? 0}</td>
          <td>${s.passYards ?? s.passingYards ?? s.pass ?? 0}</td>
          <td>${s.turnovers ?? s.to ?? 0}</td>
          <td>${s.epa ?? s.totalEPA ?? 0}</td>
        `;
        dom.teamStatsBody.appendChild(tr);
      };

      addRow(getTeamLabel(currentHomeTeam), home);
      addRow(getTeamLabel(currentAwayTeam), away);
    }

    function renderPlayerBoxScore(result) {
        const tbody = dom.playerStatsBody;
        if (!tbody) return;
        clearElement(tbody);

        const statsObj = (result && result.playerStats) || {};
        const rows = Object.values(statsObj);

        if (!rows.length) return;

        const homeId = currentHomeTeam?.teamId || currentHomeTeam?.id;
        const awayId = currentAwayTeam?.teamId || currentAwayTeam?.id;
        const homeLabel = getTeamLabel(currentHomeTeam);
        const awayLabel = getTeamLabel(currentAwayTeam);

        const anyStat = (r) => {
            const vals = [
            r.passAtt, r.passCmp, r.passYds, r.passTD, r.passInt,
            r.rushAtt, r.rushYds, r.rushTD,
            r.targets, r.receptions, r.recYds, r.recTD,
            r.fgAtt, r.fgMade, r.xpAtt, r.xpMade,
            r.puntAtt, r.puntYds
            ].map(v => Number(v) || 0);
            return vals.some(v => v > 0);
        };

        const posOrder = { QB:0, RB:1, HB:1, FB:1, WR:2, TE:3, K:4, P:5, DL:6, LB:6, DB:6 };

        rows
            .filter(anyStat)
            .sort((a, b) => {
            const ta = a.teamId === homeId ? 0 : a.teamId === awayId ? 1 : 2;
            const tb = b.teamId === homeId ? 0 : b.teamId === awayId ? 1 : 2;
            if (ta !== tb) return ta - tb;
            const pa = posOrder[a.position] ?? 9;
            const pb = posOrder[b.position] ?? 9;
            if (pa !== pb) return pa - pb;
            const ya = (Number(a.passYds||0) + Number(a.recYds||0) + Number(a.rushYds||0));
            const yb = (Number(b.passYds||0) + Number(b.recYds||0) + Number(b.rushYds||0));
            return yb - ya;
            })
            .forEach(r => {
            const teamLabel =
                r.teamId === homeId ? homeLabel :
                r.teamId === awayId ? awayLabel :
                (r.teamName || r.teamId || '');
            const pos = r.position || '';
            const cAtt = `${r.passCmp||0}/${r.passAtt||0}`;
            const fg = `${r.fgMade||0}/${r.fgAtt||0}`;
            const xp = `${r.xpMade||0}/${r.xpAtt||0}`;
            const punts = `${r.puntAtt||0}${(r.puntAtt>0) ? `, ${Math.round(r.puntYds||0)}y` : ''}`;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${r.name || r.playerId || ''}</td>
                <td>${teamLabel}</td>
                <td>${pos}</td>
                <td>${cAtt}</td>
                <td>${r.passYds||0}</td>
                <td>${r.passTD||0}</td>
                <td>${r.passInt||0}</td>
                <td>${r.rushAtt||0}</td>
                <td>${r.rushYds||0}</td>
                <td>${r.rushTD||0}</td>
                <td>${r.targets||0}</td>
                <td>${r.receptions||0}</td>
                <td>${r.recYds||0}</td>
                <td>${r.recTD||0}</td>
                <td>${fg}</td>
                <td>${xp}</td>
                <td>${punts}</td>
            `;
            tbody.appendChild(tr);
            });
        }


    function appendPlayEntries(plays, maxIndex = Infinity) {
      clearElement(dom.playLog);
      if (!plays.length) return;

      plays.forEach((p, idx) => {
        if (idx > maxIndex) return;

        const div = document.createElement('div');
        const tags = (p.tags || []).map((t) => String(t).toUpperCase());

        let extraClasses = '';
        if (p.isScoring || tags.includes('TD') || tags.includes('FG')) {
          extraClasses += ' scoring key-play';
        } else if (p.isTurnover || tags.includes('TURNOVER')) {
          extraClasses += ' turnover key-play';
        } else if (p.highImpact) {
          extraClasses += ' key-play';
        }

        div.className = `log-entry${extraClasses}`;

        const quarter = p.quarter ?? p.qtr ?? '';
        const clock =
          p.clock ??
          p.gameClock ??
          (Number.isFinite(p.clockSec) ? formatClockFromSeconds(p.clockSec) : '');

        const metaParts = [];
        if (quarter) metaParts.push(`Q${quarter}`);
        if (clock) metaParts.push(clock);
        if (p.downAndDistance) metaParts.push(p.downAndDistance);
        const meta = metaParts.join(' â€¢ ') || '&nbsp;';

        const text =
          p.text ||
          p.description ||
          p.desc ||
          '[no description]';

        div.innerHTML = `
          <div class="log-meta">${meta}</div>
          <div class="log-text">
            ${text}
          </div>
        `;
        dom.playLog.appendChild(div);
      });

      // Auto-scroll to bottom on new entries
      dom.playLog.scrollTop = dom.playLog.scrollHeight;
    }

    function renderFullGame(result) {
      renderScoreboardFromResult(result);
      renderDriveSummary(result);
      renderTeamStats(result);
      renderPlayerBoxScore(result);
      const plays = getPlayLogFromResult(result);
      appendPlayEntries(plays);

      const drives = getDrivesFromResult(result);
      if (dom.debugEngineLine) {
        dom.debugEngineLine.textContent = `Sim complete: ${
          drives.length
        } drives, ${plays.length} plays. Seed: ${
          (result.meta && result.meta.seed) || 'n/a'
        }`;
      }
    }

    function renderStepView() {
      const drives = getDrivesFromResult(currentResult);
      const plays = getPlayLogFromResult(currentResult);

      if (simMode === 'drive-step') {
        const idx = Math.max(0, stepState.driveIndex);
        renderDriveSummary(currentResult, idx);
        // show all plays up to end of that drive if drives carry play indices
        if (drives[idx] && Array.isArray(drives[idx].playIndices)) {
          const maxPlay = Math.max(...drives.slice(0, idx + 1).flatMap((d) => d.playIndices));
          appendPlayEntries(plays, maxPlay);
        } else {
          // fallback: show all plays up to approximate fraction
          const fraction = (idx + 1) / (drives.length || 1);
          const maxPlay = Math.floor((plays.length - 1) * fraction);
          appendPlayEntries(plays, maxPlay);
        }
      } else if (simMode === 'play-step') {
        const maxPlay = Math.max(0, stepState.playIndex);
        renderDriveSummary(currentResult); // full drive list is fine
        appendPlayEntries(plays, maxPlay);
      }

      // For simplicity, scoreboard always shows final score once sim is run.
      renderScoreboardFromResult(currentResult);
      renderTeamStats(currentResult);
      renderPlayerBoxScore(currentResult);
    }

    // ----- EVENT HANDLERS ----------------------------------------------------
    async function onRunSimulation() {
      if (!league || !Array.isArray(league.teams)) return;

      if (!currentHomeTeam || !currentAwayTeam) {
        setSimStatus('Select valid home and away teams.');
        return;
      }
      const homeId = currentHomeTeam.teamId || currentHomeTeam.id;
      const awayId = currentAwayTeam.teamId || currentAwayTeam.id;
      if (homeId === awayId) {
        setSimStatus('Home and away must be different teams.');
        return;
      }

      resetForNewSimulation(); // clear previous results but keep selected teams
      setSimStatus('Running simulationâ€¦');

      const rawSeed = dom.inputSeed.value.trim();
      const seed = rawSeed === '' ? undefined : safeNumber(rawSeed, undefined);

      try {
        // simulateGame may be sync or async â€“ normalize via Promise.resolve
        const result = await Promise.resolve(
          simulateGame(currentHomeTeam, currentAwayTeam, { seed, mode: simMode })
        );
        currentResult = result || {};

        if (simMode === 'full-game') {
          disableStepButtons();
          renderFullGame(currentResult);
          setSimStatus('Simulation complete. Showing full game results.');
        } else {
          // For step modes we compute once, then reveal incrementally.
          stepState = { driveIndex: -1, playIndex: -1 };
          dom.btnStepDrive.disabled = simMode !== 'drive-step';
          dom.btnStepPlay.disabled = simMode !== 'play-step';
          setSimStatus(
            simMode === 'drive-step'
              ? 'Simulation complete. Use â€œNext Driveâ€ to step through drives.'
              : 'Simulation complete. Use â€œNext Playâ€ to step through plays.'
          );
          // initial render: nothing revealed yet
          resetTablesAndLogs();
        }
      } catch (err) {
        console.error('simulateGame error', err);
        setEngineStatus('error', 'Simulation failed');
        setSimStatus('Simulation failed. Check console for details.');
        if (dom.debugEngineLine) {
          dom.debugEngineLine.textContent = `Simulation error: ${err?.message || err}`;
        }
      }
    }

    function onStepDrive() {
      if (!currentResult || simMode !== 'drive-step') return;
      const drives = getDrivesFromResult(currentResult);
      if (!drives.length) return;

      if (stepState.driveIndex < drives.length - 1) {
        stepState.driveIndex += 1;
        renderStepView();
        setSimStatus(
          stepState.driveIndex < drives.length - 1
            ? `Drive ${stepState.driveIndex + 1} of ${drives.length}.`
            : 'Last drive revealed.'
        );
      }
    }

    function onStepPlay() {
      if (!currentResult || simMode !== 'play-step') return;
      const plays = getPlayLogFromResult(currentResult);
      if (!plays.length) return;

      if (stepState.playIndex < plays.length - 1) {
        stepState.playIndex += 1;
        renderStepView();
        setSimStatus(
          stepState.playIndex < plays.length - 1
            ? `Play ${stepState.playIndex + 1} of ${plays.length}.`
            : 'Last play revealed.'
        );
      }
    }

    // ----- INIT LEAGUE LOAD --------------------------------------------------
    async function initLeague() {
        setEngineStatus('pending', 'Loading Layer 3 rostersâ€¦');
        setSimStatus('Loading teams from layer3_rosters.csvâ€¦');

        try {
            // Use the resolved CSV_URL so your engine can use either the default
            // Layer 3 roster or whatever is passed via ?players=
            league = await loadLeague(CSV_URL);

            if (!league || !Array.isArray(league.teams) || league.teams.length === 0) {
            throw new Error('No teams found in league data.');
            }

            // Populate selects
            const fragHome = document.createDocumentFragment();
            const fragAway = document.createDocumentFragment();

            league.teams.forEach((team) => {
            const id = team.teamId || team.id;
            const label = getTeamLabel(team);

            const optHome = document.createElement('option');
            optHome.value = id;
            optHome.textContent = label;
            fragHome.appendChild(optHome);

            const optAway = document.createElement('option');
            optAway.value = id;
            optAway.textContent = label;
            fragAway.appendChild(optAway);
            });

            dom.selectHome.innerHTML = '';
            dom.selectAway.innerHTML = '';
            dom.selectHome.appendChild(fragHome);
            dom.selectAway.appendChild(fragAway);

            // Helper: match a team by id / name / abbr from URL params
            const findTeamByAnyId = (value) => {
            if (!value) return null;
            const target = value.toLowerCase();
            return (
                league.teams.find((t) => {
                const id = (t.teamId || t.id || '').toString().toLowerCase();
                const name = (t.team_name || t.teamName || t.displayName || '').toLowerCase();
                const abbr = (t.abbr || '').toLowerCase();
                return id === target || name === target || abbr === target;
                }) || null
            );
            };

            // Use ?home= / ?away= if present, otherwise fall back to first two teams
            let homeTeam = findTeamByAnyId(HOME_PARAM) || league.teams[0] || null;
            let awayTeam = findTeamByAnyId(AWAY_PARAM) || league.teams[1] || null;

            if (homeTeam) {
            dom.selectHome.value = homeTeam.teamId || homeTeam.id;
            }
            if (awayTeam) {
            dom.selectAway.value = awayTeam.teamId || awayTeam.id;
            }

            syncSelectedTeamsToCards();
            resetForNewSimulation();
            enableControlsAfterLeagueLoad();
            setEngineStatus('ready', 'Engine ready (Layer 3)');
            setSimStatus('Teams loaded. Configure options and run a simulation.');

            if (dom.debugEngineLine) {
            dom.debugEngineLine.textContent = `League loaded: ${
                league.teams.length
            } teams from ${CSV_URL}.`;
            }

            await probeCSV(CSV_URL);
        } catch (err) {
            console.error('loadLeague error', err);
            setEngineStatus('error', 'Failed to load league');
            setSimStatus('Failed to load league data. See console for details.');
            if (dom.debugEngineLine) {
            dom.debugEngineLine.textContent = `League load error: ${
                err?.message || err
            }`;
            }
        }
    }


    // ----- BOOTSTRAP ---------------------------------------------------------
    (async function bootstrap() {
      wireSimModeRadios();
      wireControls();
      resetForNewSimulation();
      await initLeague();
    })();
  </script>

</body>
</html>
